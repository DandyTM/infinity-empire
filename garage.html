<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ì–∞—Ä–∞–∂ ‚Äî INFINITY Empire</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:Inter,sans-serif;background:#fff;color:#111;}
.top-info{position:fixed;top:16px;left:16px;display:flex;align-items:center;gap:14px;z-index:1000;}
.info-box{background:rgba(255,255,255,0.35);backdrop-filter:blur(12px);border-radius:18px;padding:8px 16px;font-size:18px;font-weight:600;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 18px rgba(0,0,0,0.28);}
.back-arrow{width:30px;height:30px;cursor:pointer;transition:.25s;opacity:.9;}
.back-arrow:hover{transform:translateX(-4px);opacity:1;}

.page-title{text-align:center;font-size:27px;font-weight:700;margin-top:90px;}

.cars{margin-top:30px;display:grid;grid-template-columns:repeat(3,300px);justify-content:center;gap:42px;padding-bottom:60px;}
.car-card{width:300px;background:#fff;border-radius:26px;padding:18px;cursor:pointer;transition:.28s;box-shadow:0 18px 45px rgba(0,0,0,0.28),0 0 18px rgba(0,0,0,0.22);display:flex;flex-direction:column;align-items:center;}
.car-card:hover{transform:scale(1.05);}
.car-card img{width:100%;height:160px;border-radius:18px;object-fit:cover;}
.car-name{text-align:center;font-size:17px;font-weight:600;margin-top:6px;}
.stage-badge{background:#111;color:#fff;font-size:12px;padding:3px 8px;border-radius:8px;margin-top:4px;}
.car-power{font-size:15px;color:#444;margin-top:4px;}

.plate-small{display:inline-flex;background:#fff;border:3px solid #000;border-radius:4px;height:48px;overflow:hidden;margin-top:10px;}
.plate-left{display:flex;align-items:center;gap:6px;padding:0 10px}
.plate-letter{font-size:34px}
.plate-nums{font-size:36px;letter-spacing:2px}
.plate-letters{display:flex;gap:4px;font-size:32px}
.plate-region{display:flex;flex-direction:column;align-items:center;justify-content:center;border-left:3px solid #000;padding:2px 8px;}
.plate-region .region{font-size:20px;font-weight:700}
.flag{width:18px;height:11px;border:1px solid #000;background:linear-gradient(to bottom,#fff 33%,#0039A6 33% 66%,#D52B1E 66%)}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(7px);display:none;justify-content:center;align-items:center;z-index:2000;}
.modal{background:#fff;border-radius:26px;padding:22px;width:900px;min-height:450px;display:flex;gap:24px;align-items:flex-start;box-shadow:0 20px 50px rgba(0,0,0,0.35);position:relative;}
#carImg{
width:450px;height:380px;border-radius:22px;
object-fit:cover;
overflow:hidden;
background:#fff;
}
.modal-info{flex:1;text-align:left;}
.close-x{position:absolute;top:18px;right:24px;font-size:28px;cursor:pointer;opacity:.7;transition:.2s;}
.close-x:hover{opacity:1;}

.btn-row{display:flex;gap:12px;margin-top:18px;}
.btn{flex:1;padding:12px;border-radius:12px;font-size:17px;font-weight:600;background:#111;color:#fff;cursor:pointer;transition:.25s;text-align:center;}
.btn:disabled{background:#999;cursor:not-allowed;opacity:.6;}
.sell-btn{margin-top:12px;width:100%;padding:12px;border-radius:12px;font-size:18px;font-weight:600;background:#c90000;color:#fff;cursor:pointer;transition:.25s;}
.sell-btn:hover{opacity:.9;}

.wear-block{margin-top:14px;}
.wear-row{display:flex;align-items:center;margin:9px 0;cursor:pointer;}
.wear-name{width:120px;font-size:14px;}
.wear-perc{font-size:14px;font-weight:600;margin-left:8px;}
.wear-bar-bg{flex:1;height:9px;border-radius:4px;background:#e5e5e5;margin:0 10px;overflow:hidden;}
.wear-bar-fill{height:9px;border-radius:4px;transition:.25s;}

#repairBg,#tuneBg{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(7px);display:none;justify-content:center;align-items:center;z-index:3000;}
.popbox{background:#fff;padding:20px;border-radius:18px;width:300px;text-align:center;box-shadow:0 14px 38px rgba(0,0,0,0.35);}
.popbox h3{margin:0 0 10px;font-size:20px;font-weight:700;}
.popbox p{font-size:15px;color:#444;margin-bottom:14px;}
.popbox .btn{width:100%;margin-top:6px;}
</style>
</head>

<body>

<script src="../assets/js/bankNotify.js"></script>

<div class="top-info">
<svg class="back-arrow" onclick="location.href='profile.html'" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
<div class="info-box" id="balanceBox">–ë–∞–ª–∞–Ω—Å: ...</div>
</div>

<div class="page-title">–ì–∞—Ä–∞–∂</div>

<div class="cars" id="carsGrid"></div>

<div class="modal-bg" id="modalBg">
<div class="modal">
<div class="close-x" onclick="closeModal()">√ó</div>
<img id="carImg">
<div class="modal-info">
<h2 id="carTitle"></h2>
<p id="modalSpecs"></p>
<p id="modalPrice" style="font-weight:700;margin-top:8px"></p>

<div id="modalPlate" style="margin-top:12px;"></div>
<div id="noPlateBtn" style="margin-top:12px;display:none;">
<button class="btn" onclick="goToGAI()">–û—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–º–µ—Ä</button>
</div>

<p id="modalMileage" style="font-size:14px;color:#555;"></p>

<div class="wear-block" id="wearBlock"></div>

<div class="btn-row">
<button class="btn" id="tuneBtn">–¢—é–Ω–∏–Ω–≥</button>
<button class="btn" id="repairBtn"">–†–µ–º–æ–Ω—Ç</button>
<button class="sell-btn" id="sellBtn">–ü—Ä–æ–¥–∞—Ç—å</button>
</div>
</div>
</div>

<div id="repairBg">
<div class="popbox">
<h3 id="repairTitle"></h3>
<p id="repairCost"></p>
<button class="btn" onclick="confirmRepair()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
<button class="btn" onclick="repairBg.style.display='none'">–û—Ç–º–µ–Ω–∞</button>
</div>
</div>

<div id="tuneBg">
<div class="popbox">
<h3 id="tuneTitle"></h3>
<p id="tuneStats"></p>
<p id="tuneCost"></p>
<button class="btn" id="applyTune">–£–ª—É—á—à–∏—Ç—å</button>
<button class="btn" id="rollbackTune">–û—Ç–∫–∞—Ç–∏—Ç—å (-1 Stage) 10 000 ‚ÇΩ</button>
<button class="btn" onclick="tuneBg.style.display='none'">–ù–∞–∑–∞–¥</button>
</div>
</div>

<script>
function fmt(n){return Number(n).toLocaleString('ru-RU');}
function R(){return parseFloat(localStorage.getItem('balance_rub'))||0;}
function W(v){localStorage.setItem('balance_rub',v);}
function UB(){balanceBox.textContent="–ë–∞–ª–∞–Ω—Å: "+fmt(R())+" ‚ÇΩ";} UB();

let garage = JSON.parse(localStorage.getItem('garage')||'[]');
garage.forEach(c=>{
 if(!c.mileage) c.mileage=0;
 if(!c.stage) c.stage=0;
 if(!c.wear){c.wear={engine:100,gearbox:100,suspension:100,brakes:100,body:100,electronics:100};}
});
localStorage.setItem("garage",JSON.stringify(garage));

function classCost(c){
let p=c.priceRub||c.price;
if(p<=1_000_000) return 50;
if(p<=4_000_000) return 150;
if(p<=10_000_000) return 400;
return 900;
}

function plateSmallHtml(p){
const m=p.match(/^(.)(\d{3})(..)(\d+)$/);
return `<div class="plate-small"><div class="plate-left"><div class="plate-letter">${m[1]}</div><div class="plate-nums">${m[2]}</div><div class="plate-letters"><span>${m[3][0]}</span><span>${m[3][1]}</span></div></div><div class="plate-region"><div class="region">${m[4]}</div><div class="flag"></div></div></div>`;
}

function render(){
carsGrid.innerHTML="";
garage.forEach((c,i)=>{
carsGrid.innerHTML+=`
<div class="car-card" onclick="openModal(${i})">
<img src="${c.image}">
<div class="car-name">${c.brand} ${c.model}</div>
${c.stage>0?`<div class="stage-badge">Stage ${c.stage}</div>`:''}
<div class="car-power">${c.power} –ª.—Å.</div>
${c.plate?plateSmallHtml(c.plate):''}
</div>`;
});
}
render();

let cur=0;

function openModal(i){
cur=i; const c=garage[i];

carImg.src=c.image;
carTitle.innerHTML = c.brand+" "+c.model+(c.stage>0?` <span class="stage-badge">Stage ${c.stage}</span>`:"");

modalSpecs.textContent=`${c.variant||''} ‚Ä¢ ${c.power} –ª.—Å. ‚Ä¢ ${c.drive||''} ‚Ä¢ 0‚Äì100: ${c.zero||''} c`;
modalPrice.textContent="–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏: "+fmt(c.priceRub||c.price)+" ‚ÇΩ";
modalMileage.textContent="–ü—Ä–æ–±–µ–≥: "+fmt(c.mileage)+" –∫–º";

if(c.plate){ modalPlate.innerHTML=plateSmallHtml(c.plate); noPlateBtn.style.display="none"; }
else { modalPlate.innerHTML=""; noPlateBtn.style.display="block"; }

wearBlock.innerHTML = wearHTML(c.wear);
checkRepairButton();
modalBg.style.display="flex";
}

function checkRepairButton(){
const c=garage[cur];
const arr=Object.values(c.wear);
repairBtn.disabled = arr.every(v=>v===100);
}

function wearHTML(w){
function col(v){return v>=80?"#41d16e":v>=50?"#e8c61c":"#d84242";}
function row(n,k){return `
<div class="wear-row" onclick="selectPart('${k}')">
<div class="wear-name">${n}</div>
<div class="wear-bar-bg"><div class="wear-bar-fill" style="width:${w[k]}%;background:${col(w[k])};"></div></div>
<div class="wear-perc" style="color:${col(w[k])};">${w[k]}%</div>
</div>`;}
return `
${row("–î–≤–∏–≥–∞—Ç–µ–ª—å","engine")}
${row("–ö–æ—Ä–æ–±–∫–∞","gearbox")}
${row("–ü–æ–¥–≤–µ—Å–∫–∞","suspension")}
${row("–¢–æ—Ä–º–æ–∑–∞","brakes")}
${row("–ö—É–∑–æ–≤","body")}
${row("–≠–ª–µ–∫—Ç—Ä–∏–∫–∞","electronics")}
`;
}

function closeModal(){modalBg.style.display="none";}
function goToGAI(){localStorage.setItem("selected_garage_car",cur);location.href="dealership/gai.html";}

let repairPart="";
function selectPart(part){
repairPart=part;
const c=garage[cur];
if(c.wear[part]>=100) return;
const cost=(100-c.wear[part])*classCost(c);
repairTitle.textContent="–†–µ–º–æ–Ω—Ç: "+part;
repairCost.textContent="–°—Ç–æ–∏–º–æ—Å—Ç—å: "+fmt(cost)+" ‚ÇΩ";
repairBg.style.display="flex";
}

repairBtn.onclick=function(){
  const c = garage[cur];
  // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ % –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—É–º–º–∞—Ä–Ω–æ
  let need = 0;
  for(let k in c.wear) need += (100 - c.wear[k]);

  if(need === 0) return showBankNotification(0,"–ê–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–µ–Ω ‚úÖ");

  const price = need * classCost(c);

  if(R() < price) return showBankNotification(0,"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ ‚ùå");

  W(R() - price); UB();

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏
  for(let k in c.wear) c.wear[k] = 100;

  localStorage.setItem("garage", JSON.stringify(garage));
  openModal(cur);
  showBankNotification(-price, "–ê–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω üîß");
}



// Tuning
tuneBtn.onclick=function(){
const c=garage[cur];
tuneTitle.textContent="–¢—é–Ω–∏–Ω–≥ Stage "+c.stage;
const next=c.stage<3?c.stage+1:null;
if(next){
const np=Math.round(c.power*( [1,1.15,1.30,1.55][next] / [1,1.15,1.30,1.55][c.stage] ));
const nz=(c.zero*( [1,0.93,0.85,0.75][next] / [1,0.93,0.85,0.75][c.stage] )).toFixed(1);
tuneStats.innerHTML=`–ú–æ—â–Ω–æ—Å—Ç—å: ${c.power} ‚Üí ${np}<br>0‚Äì100: ${c.zero} ‚Üí ${nz}`;
tuneCost.textContent="–°—Ç–æ–∏–º–æ—Å—Ç—å: "+fmt(getTuneCost(c,next))+" ‚ÇΩ";
applyTune.onclick=function(){applyStage(next,np,nz);}
applyTune.style.display="block";
}else{
tuneStats.innerHTML="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Ç—é–Ω–∏–Ω–≥–∞.";
tuneCost.textContent="";
applyTune.style.display="none";
}
rollbackTune.disabled=(c.stage===0);
tuneBg.style.display="flex";
}

function getTuneCost(c,stage){
const p=c.priceRub||c.price;
if(p<=1_000_000) return [0,30000,45000,80000][stage];
if(p<=4_000_000) return [0,70000,110000,190000][stage];
if(p<=10_000_000) return [0,150000,235000,420000][stage];
return [0,350000,500000,900000][stage];
}

function applyStage(next,np,nz){
const c=garage[cur];
const cost=getTuneCost(c,next);
if(R()<cost) return showBankNotification(0,"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ ‚ùå");
W(R()-cost); UB();
c.power=np; c.zero=nz; c.stage=next;
localStorage.setItem("garage",JSON.stringify(garage));
tuneBg.style.display="none";
openModal(cur); render();
showBankNotification(-cost,"–¢—é–Ω–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω üî•");
}

rollbackTune.onclick=function(){
const c=garage[cur];
if(c.stage===0) return;
if(R()<10000) return showBankNotification(0,"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ ‚ùå");
W(R()-10000); UB();
c.stage--;
const ratio=[1,1.15,1.30,1.55];
const zr=[1,0.93,0.85,0.75];
c.power=Math.round(c.power*(ratio[c.stage]/ratio[c.stage+1]));
c.zero=(c.zero*(zr[c.stage]/zr[c.stage+1])).toFixed(1);
localStorage.setItem("garage",JSON.stringify(garage));
tuneBg.style.display="none";
openModal(cur); render();
showBankNotification(-10000,"–û—Ç–∫–∞—Ç —Ç—é–Ω–∏–Ω–≥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω ‚Ü©Ô∏è");
}

sellBtn.onclick=function(){
const c=garage[cur];
const avg=(c.wear.engine+c.wear.gearbox+c.wear.suspension+c.wear.brakes+c.wear.body+c.wear.electronics)/6;
const pen=(1-(avg/100))*0.35;
const base=(c.priceRub||c.price);
const sp=Math.max(5000,Math.round(base*(0.70-pen)));
W(R()+sp); UB();
garage.splice(cur,1);
localStorage.setItem("garage",JSON.stringify(garage));
closeModal(); render();
showBankNotification(sp,"–ê–≤—Ç–æ–º–æ–±–∏–ª—å –ø—Ä–æ–¥–∞–Ω üìâ");
};
</script>

</body>
</html>

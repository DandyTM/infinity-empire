<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω ‚Äî INFINITY Empire</title>
  <style>
    :root { --accent:#00e0c6; --glass: rgba(255,255,255,0.15); }
    html,body { margin:0; height:100%; font-family: 'Inter', system-ui, Arial, sans-serif;
      background: linear-gradient(180deg,#20C6B8 0%,#1A2C5B 100%); color:#fff; }

    /* –≤–µ—Ä—Ö–Ω–∏–µ –ø–ª–∞—à–∫–∏ */
    .top-info{ position:fixed; top:16px; left:50%; transform:translateX(-50%);
      display:flex; align-items:center; gap:8px; z-index:1000; flex-wrap:wrap; }
    .info-box{ background:var(--glass); backdrop-filter: blur(10px);
      border-radius:20px; padding:12px 18px; font-size:16px; font-weight:700;
      border:1px solid rgba(255,255,255,0.25); white-space:nowrap; }

    /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —à–µ—Å—Ç–µ—Ä—ë–Ω–∫–∞ */
    .wrap{ margin-top:120px; padding:0 12px 110px; }
    .title-row{ display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:12px; }
    .title{ font-size:22px; font-weight:900; }
    .gear{ width:26px; height:26px; cursor:pointer; filter: drop-shadow(0 0 4px rgba(0,0,0,.35)); }

    /* –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç—É–ø–µ–Ω–µ–π */
    .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
      gap:14px; max-width:980px; margin:0 auto; }
    .card{ background:#fff; color:#111; border-radius:18px; padding:14px 14px 16px;
      box-shadow:0 10px 28px rgba(0,0,0,.22); }
    .card h3{ margin:0 0 8px; font-size:18px; display:flex; align-items:center; gap:8px; }
    .row{ display:flex; align-items:center; justify-content:space-between; margin:6px 0; }
    .muted{ color:#555; font-weight:600; }
    .strong{ font-weight:800; }
    .btn{ width:100%; margin-top:10px; background:var(--accent); color:#03201b; border:none;
      border-radius:12px; padding:12px 14px; font-weight:900; cursor:pointer; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .hint{ font-size:12px; color:#666; margin-top:6px; }

    /* –º–æ–¥–∞–ª–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
    .modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:2000; }
    .modal{ width:min(92vw,560px); background:#0b182f; color:#e9f7f5; border-radius:16px; padding:16px;
      border:1px solid rgba(255,255,255,.18); box-shadow:0 18px 48px rgba(0,0,0,.55); }
    .modal h3{ margin:0 0 10px; font-size:18px; }
    .kvs{ display:grid; grid-template-columns: 1fr auto; row-gap:8px; column-gap:10px; }
    .kbd{ font-weight:700; opacity:.9; }
    .val{ font-weight:900; }
    .modal-actions{ display:flex; gap:10px; margin-top:14px; }
    .btn-ghost{ flex:1; background:transparent; border:1px solid rgba(255,255,255,.25);
      color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .btn-danger{ flex:1; background:#ff3b30; color:#fff; font-weight:900; border:none;
      border-radius:10px; padding:10px 12px; cursor:pointer; }
    .danger-note{ font-size:12px; color:#ffb4af; margin-top:6px; }

    /* –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å ‚Äî –ù–ï –¢–†–û–ì–ê–ï–ú, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∏–ª–∏ –ø–æ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–∞–∑–º–µ—Ç–∫—É */
    .bottom-nav{ position:fixed; bottom:0; left:0; right:0; height:70px; background:var(--glass);
      backdrop-filter: blur(10px); display:flex; justify-content:space-around; align-items:center; z-index:1000; }
    .nav-item{ display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#fff; font-size:12px; }
    .nav-item img{ width:28px; height:28px; margin-bottom:4px; }
    .nav-item.active span{ color:var(--accent); }
  </style>
</head>
<body>

  <!-- –≤–µ—Ä—Ö: –±–∞–ª–∞–Ω—Å –∏ —Å—É–º–º–∞—Ä–Ω—ã–π –¥–æ—Ö–æ–¥ –≤ —á–∞—Å -->
  <div class="top-info">
    <div class="info-box" id="balanceBox">–ë–∞–ª–∞–Ω—Å: 0 ‚ÇΩ</div>
    <div class="info-box" id="incomeBox">üí∞ –î–æ—Ö–æ–¥ –≤ —á–∞—Å: 0 ‚ÇΩ</div>
  </div>

  <div class="wrap">
    <div class="title-row">
      <div class="title">–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω</div>
      <!-- –∏–∫–æ–Ω–∫—É —à–µ—Å—Ç–µ—Ä—ë–Ω–∫–∏ –º–æ–∂–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π svg/png -->
      <img class="gear" id="gearBtn" src="../assets/icons/gear.svg" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" />
    </div>

    <div class="grid" id="stages">

      <!-- –ú–µ—Å—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω -->
      <div class="card" data-stage="local">
        <h3>üè™ –ú–µ—Å—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω</h3>
        <div class="row"><div class="muted">–£—Ä–æ–≤–µ–Ω—å</div><div class="strong" id="local_lvl">0</div></div>
        <div class="row"><div class="muted">–î–æ—Ö–æ–¥/—á–∞—Å</div><div class="strong" id="local_iph">0 ‚ÇΩ/—á</div></div>
        <div class="row"><div class="muted">–¶–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div><div class="strong" id="local_cost">150 000 ‚ÇΩ</div></div>
        <button class="btn" id="local_btn">–ö—É–ø–∏—Ç—å/–£–ª—É—á—à–∏—Ç—å</button>
        <div class="hint">L1: 150 000 ‚ÇΩ; L2: 45 000 ‚ÇΩ; –¥–∞–ª–µ–µ —Ü–µ–Ω–∞ √ó1.30 (–∫—Ä–∞—Ç–Ω–æ 1000), –¥–æ—Ö–æ–¥ √ó1.20/—É—Ä.</div>
      </div>

      <!-- –ù–µ–±–æ–ª—å—à–∞—è —Å–µ—Ç—å -->
      <div class="card" data-stage="chain">
        <h3>üõí –ù–µ–±–æ–ª—å—à–∞—è —Å–µ—Ç—å</h3>
        <div class="row"><div class="muted">–£—Ä–æ–≤–µ–Ω—å</div><div class="strong" id="chain_lvl">0</div></div>
        <div class="row"><div class="muted">–î–æ—Ö–æ–¥/—á–∞—Å</div><div class="strong" id="chain_iph">0 ‚ÇΩ/—á</div></div>
        <div class="row"><div class="muted">–¶–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div><div class="strong" id="chain_cost">1 200 000 ‚ÇΩ</div></div>
        <button class="btn" id="chain_btn">–ö—É–ø–∏—Ç—å/–£–ª—É—á—à–∏—Ç—å</button>
        <div class="hint">L1: 1 200 000 ‚ÇΩ; L2: 360 000 ‚ÇΩ; –¥–∞–ª–µ–µ —Ü–µ–Ω–∞ √ó1.30 (–∫—Ä–∞—Ç–Ω–æ 1000), –¥–æ—Ö–æ–¥ √ó1.20/—É—Ä.</div>
      </div>

      <!-- –ö—Ä—É–ø–Ω–∞—è —Å–µ—Ç—å -->
      <div class="card" data-stage="corp">
        <h3>üè¨ –ö—Ä—É–ø–Ω–∞—è —Å–µ—Ç—å</h3>
        <div class="row"><div class="muted">–£—Ä–æ–≤–µ–Ω—å</div><div class="strong" id="corp_lvl">0</div></div>
        <div class="row"><div class="muted">–î–æ—Ö–æ–¥/—á–∞—Å</div><div class="strong" id="corp_iph">0 ‚ÇΩ/—á</div></div>
        <div class="row"><div class="muted">–¶–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è</div><div class="strong" id="corp_cost">9 600 000 ‚ÇΩ</div></div>
        <button class="btn" id="corp_btn">–ö—É–ø–∏—Ç—å/–£–ª—É—á—à–∏—Ç—å</button>
        <div class="hint">L1: 9 600 000 ‚ÇΩ; L2: 2 880 000 ‚ÇΩ; –¥–∞–ª–µ–µ —Ü–µ–Ω–∞ √ó1.30 (–∫—Ä–∞—Ç–Ω–æ 1000), –¥–æ—Ö–æ–¥ √ó1.20/—É—Ä.</div>
      </div>

    </div>
  </div>

  <!-- –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–Ω–µ —Ç—Ä–æ–≥–∞—é —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞—é –ø—Ä–∏–º–µ—Ä —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å—Ç–∏–ª–µ–π) -->
  <div class="bottom-nav">
    <a href="../fun.html" class="nav-item"><img src="../assets/fun.png"><span>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</span></a>
    <a href="../business.html" class="nav-item active"><img src="../assets/business.png"><span>–ë–∏–∑–Ω–µ—Å—ã</span></a>
    <a href="../index.html" class="nav-item"><img src="../assets/earn.png"><span>–ó–∞—Ä–∞–±–æ—Ç–æ–∫</span></a>
    <a href="../profile.html" class="nav-item"><img src="../assets/profile.png"><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
    <a href="../settings.html" class="nav-item"><img src="../assets/settings.png"><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></a>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö -->
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <h3>–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
      <div class="kvs">
        <div class="kbd">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è</div><div class="val" id="m_earned">0 ‚ÇΩ</div>
        <div class="kbd">–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (–≤–ª–æ–∂–µ–Ω–æ)</div><div class="val" id="m_invested">0 ‚ÇΩ</div>
        <div class="kbd">–¢–µ–∫—É—â–∏–π –¥–æ—Ö–æ–¥ –≤ —á–∞—Å</div><div class="val" id="m_iph">0 ‚ÇΩ/—á</div>
        <div class="kbd">–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞ 1 —á</div><div class="val" id="m_fore1">0 ‚ÇΩ</div>
        <div class="kbd">–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞ 24 —á</div><div class="val" id="m_fore24">0 ‚ÇΩ</div>
        <div class="kbd">–°—Ä–µ–¥–Ω–∏–π ROI</div><div class="val" id="m_roi">‚Äî</div>
      </div>

      <div class="danger-note">–ó–∞–∫—Ä—ã—Ç–∏–µ –±–∏–∑–Ω–µ—Å–∞ –≤–µ—Ä–Ω—ë—Ç <b>30%</b> –æ—Ç –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –±–∞–ª–∞–Ω—Å –∏ <u>—Å–±—Ä–æ—Å–∏—Ç –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –∏ –¥–æ—Ö–æ–¥</u> —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.</div>
      <div class="modal-actions">
        <button class="btn-ghost" id="closeModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn-danger" id="closeBizBtn">–ó–∞–∫—Ä—ã—Ç—å –±–∏–∑–Ω–µ—Å (30%)</button>
      </div>
    </div>
  </div>

<script>
  // ====== –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –≤–∞–ª—é—Ç—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const rates = {"‚ÇΩ":1,"‚Ç∏":6.5,"$":0.012,"‚Ç¨":0.011};
  const getCur = () => localStorage.getItem('currency') || '‚ÇΩ';
  const fmt = (n) => Number(n).toLocaleString('ru-RU',{minimumFractionDigits:0, maximumFractionDigits:0});
  const fmt2 = (n) => Number(n).toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2});

  // ====== –∫–ª—é—á–∏ –¥–ª—è "–ü—Ä–æ–¥—É–∫—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞"
  const K = {
    // –ø–æ —Å—Ç—É–ø–µ–Ω—è–º
    local_lvl: 'biz_grocery_local_lvl',
    local_iph: 'biz_grocery_local_iph',
    chain_lvl: 'biz_grocery_chain_lvl',
    chain_iph: 'biz_grocery_chain_iph',
    corp_lvl:  'biz_grocery_corporate_lvl',
    corp_iph:  'biz_grocery_corporate_iph',
    // –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –±–∏–∑–Ω–µ—Å—É
    invested:  'biz_grocery_total_invested_rub',
    earned:    'biz_grocery_total_earned_rub',
    iph_sum:   'biz_grocery_iph',
    updated:   'biz_grocery_updated_at',
  };
  const K_NAME = 'biz_grocery_name';

  // ====== –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—É–ø–µ–Ω–µ–π
  const P = {
    local: { baseCost:150000, l2:45000, costK:1.30, baseIPH:3600, incomeK:1.20, maxL:10 },
    chain: { baseCost:1200000, l2:360000, costK:1.30, baseIPH:30000, incomeK:1.20, maxL:10 },
    corp:  { baseCost:9600000, l2:2880000, costK:1.30, baseIPH:240000, incomeK:1.20, maxL:10 },
  };

  // –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 1000
  const round1000 = (x)=> Math.round(x/1000)*1000;

  // —Ü–µ–Ω–∞ —É—Ä–æ–≤–Ω—è L (L>=1)
  function priceOf(stage, L){
    const cfg = P[stage];
    if(L===1) return cfg.baseCost;
    if(L===2) return cfg.l2;
    // –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ü–µ–Ω—ã
    let prev = priceOf(stage, L-1);
    return round1000(prev * cfg.costK);
  }

  // —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è = priceOf(L+1)
  function nextPrice(stage, lvl){
    const nextL = Math.min(lvl+1, P[stage].maxL);
    return priceOf(stage, nextL);
  }

  // –¥–æ—Ö–æ–¥ –Ω–∞ —É—Ä–æ–≤–Ω–µ L
  function iphOf(stage, L){
    if (L<=0) return 0;
    const cfg = P[stage];
    return Math.round(cfg.baseIPH * Math.pow(cfg.incomeK, L-1));
  }

  // ====== —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å RUB
  const getRub = (k)=> parseFloat(localStorage.getItem(k)||'0') || 0;
  const setRub = (k,v)=> localStorage.setItem(k, String(v));
  const getInt = (k)=> parseInt(localStorage.getItem(k)||'0') || 0;
  const setInt = (k,v)=> localStorage.setItem(k, String(v));

  // ====== –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç—É–ø–µ–Ω–µ–π
  function getLvl(stage){
    if(stage==='local') return getInt(K.local_lvl);
    if(stage==='chain') return getInt(K.chain_lvl);
    if(stage==='corp')  return getInt(K.corp_lvl);
  }
  function setLvl(stage, v){
    if(stage==='local') return setInt(K.local_lvl, v);
    if(stage==='chain') return setInt(K.chain_lvl, v);
    if(stage==='corp')  return setInt(K.corp_lvl, v);
  }
  function setStageIPH(stage, iph){
    if(stage==='local') return setRub(K.local_iph, iph);
    if(stage==='chain') return setRub(K.chain_iph, iph);
    if(stage==='corp')  return setRub(K.corp_iph, iph);
  }
  function getStageIPH(stage){
    if(stage==='local') return getRub(K.local_iph);
    if(stage==='chain') return getRub(K.chain_iph);
    if(stage==='corp')  return getRub(K.corp_iph);
  }

  // ====== –∞–≥—Ä–µ–≥–∞—Ç—ã –±–∏–∑–Ω–µ—Å–∞
  function recalcGroceryIPH(){
    const sum = getRub(K.local_iph) + getRub(K.chain_iph) + getRub(K.corp_iph);
    setRub(K.iph_sum, sum);
    return sum;
  }

  function addInvested(v){ setRub(K.invested, getRub(K.invested) + v); }
  function addEarned(v){ setRub(K.earned, getRub(K.earned) + v); }

  // ====== –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
  const BAL_K = 'balance_rub';
  const IPH_GLOBAL_K = 'income_per_hour';

  function getBalance(){ return getRub(BAL_K); }
  function setBalance(v){ setRub(BAL_K, v); }

  function recalcIncomePerHourGlobal(){
    // –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±–Ω–æ–≤–∏–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥: –≤—ã—á–µ—Å—Ç—å —Å—Ç–∞—Ä—ã–π –≤–∫–ª–∞–¥ grocery –∏ –ø—Ä–∏–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π
    const prevG = getRub(K.iph_sum);
    const newG = recalcGroceryIPH();
    const total = (parseFloat(localStorage.getItem(IPH_GLOBAL_K))||0) - prevG + newG;
    localStorage.setItem(IPH_GLOBAL_K, String(Math.max(0,total)));
    return Math.max(0,total);
  }

  // ====== UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∞–ø–∫–∏
  function refreshTopBars(){
    const cur = getCur();
    const bal = getBalance()*rates[cur];
    const iphTot = (parseFloat(localStorage.getItem(IPH_GLOBAL_K))||0)*rates[cur];
    document.getElementById('balanceBox').textContent = `–ë–∞–ª–∞–Ω—Å: ${fmt2(bal)} ${cur}`;
    document.getElementById('incomeBox').textContent  = `üí∞ –î–æ—Ö–æ–¥ –≤ —á–∞—Å: ${fmt2(iphTot)} ${cur}`;
  }

  // ====== UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
  function refreshStage(stage){
    const lvl = getLvl(stage);
    const iph = iphOf(stage, lvl);
    setStageIPH(stage, iph);

    const cur = getCur();
    document.getElementById(`${stage}_lvl`).textContent = lvl;
    document.getElementById(`${stage}_iph`).textContent = `${fmt(iph*rates[cur])} ${cur}/—á`;
    document.getElementById(`${stage}_cost`).textContent = `${fmt(nextPrice(stage, lvl)*rates[cur])} ${cur}`;
  }

  function refreshAll(){
    ['local','chain','corp'].forEach(refreshStage);
    recalcIncomePerHourGlobal();
    refreshTopBars();
  }

  // ====== –ø–æ–∫—É–ø–∫–∞/–∞–ø–≥—Ä–µ–π–¥
  function upgrade(stage){
    const lvl = getLvl(stage);
    if(lvl >= P[stage].maxL) return;

    const price = nextPrice(stage, lvl); // –≤ —Ä—É–±–ª—è—Ö
    let bal = getBalance();
    if(bal < price){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return; }

    // –æ–ø–ª–∞—Ç–∞
    setBalance(bal - price);
    addInvested(price);

    // –∞–ø–≥—Ä–µ–π–¥ —É—Ä–æ–≤–Ω—è
    const newLvl = Math.min(lvl+1, P[stage].maxL);
    setLvl(stage, newLvl);
    setStageIPH(stage, iphOf(stage, newLvl));

    // –ø–µ—Ä–µ—Å—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤
    recalcIncomePerHourGlobal();
    refreshAll();
  }

  // ====== –º–æ–¥–∞–ª–∫–∞
  const modalBack = document.getElementById('modalBack');
  document.getElementById('gearBtn').onclick = openModal;
  document.getElementById('closeModalBtn').onclick = closeModal;
  document.getElementById('closeBizBtn').onclick = onCloseBusiness;

  function openModal(){
    // –ø–æ–¥—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫
    const invested = getRub(K.invested);
    const iph = recalcGroceryIPH();
    const earned = getRub(K.earned);
    const cur = getCur();

    document.getElementById('m_earned').textContent = `${fmt2(earned*rates[cur])} ${cur}`;
    document.getElementById('m_invested').textContent = `${fmt2(invested*rates[cur])} ${cur}`;
    document.getElementById('m_iph').textContent = `${fmt2(iph*rates[cur])} ${cur}/—á`;
    document.getElementById('m_fore1').textContent = `${fmt2(iph*rates[cur])} ${cur}`;
    document.getElementById('m_fore24').textContent = `${fmt2(iph*24*rates[cur])} ${cur}`;
    document.getElementById('m_roi').textContent = iph>0 ? `${fmt2(invested/iph)} —á` : '‚Äî';

    modalBack.style.display = 'flex';
  }
  function closeModal(){ modalBack.style.display = 'none'; }

  // ====== –∑–∞–∫—Ä—ã—Ç–∏–µ –±–∏–∑–Ω–µ—Å–∞ (30% –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
  function onCloseBusiness(){
    const invested = getRub(K.invested);
    const payout = Math.floor(invested * 0.30); // ‚ÇΩ

    const cur = getCur();
    const pretty = `${fmt2(payout*rates[cur])} ${cur}`;

    if(!confirm(`–í—ã –ø–æ–ª—É—á–∏—Ç–µ 30% –æ—Ç –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏: ${pretty}. –í—Å–µ —É—Ä–æ–≤–Ω–∏ –∏ –¥–æ—Ö–æ–¥ —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)){
      return;
    }

    // 1) –≤—ã–ø–ª–∞—Ç–∞
    setBalance(getBalance() + payout);

    // 2) —Å–±—Ä–æ—Å —É—Ä–æ–≤–Ω–µ–π –∏ –¥–æ—Ö–æ–¥–æ–≤ —Å—Ç—É–ø–µ–Ω–µ–π
    setLvl('local', 0); setStageIPH('local', 0);
    setLvl('chain', 0); setStageIPH('chain', 0);
    setLvl('corp',  0); setStageIPH('corp',  0);

    // 3) —Å–±—Ä–æ—Å –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏; –¥–æ—Ö–æ–¥ –±–∏–∑–Ω–µ—Å–∞ –≤ 0
    setRub(K.invested, 0);
    setRub(K.iph_sum, 0);

    // 4) –ø–µ—Ä–µ—Å—á—ë—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –∏ UI
    recalcIncomePerHourGlobal();
    refreshAll();
    closeModal();
    alert(`–ë–∏–∑–Ω–µ—Å –∑–∞–∫—Ä—ã—Ç. –í—ã–ø–ª–∞—Ç–∞: ${pretty}`);
  }
  // –µ—Å–ª–∏ —É –≤—Å–µ—Ö —Å—Ç—É–ø–µ–Ω–µ–π —É—Ä–æ–≤–µ–Ω—å 0 ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–∞ –º–∞—Å—Ç–µ—Ä –ø–æ–∫—É–ø–∫–∏
  if (
    (parseInt(localStorage.getItem(K.local_lvl)||'0')||0)===0 &&
    (parseInt(localStorage.getItem(K.chain_lvl)||'0')||0)===0 &&
    (parseInt(localStorage.getItem(K.corp_lvl)||'0')||0)===0
  ){
    location.replace('grocery-start.html');
  }

// –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º
const nm = localStorage.getItem(K_NAME) || '–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω';
document.querySelector('.title').textContent = nm;

  // ====== –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  ['local','chain','corp'].forEach(s=>{
    if(getLvl(s) < 0 || isNaN(getLvl(s))) setLvl(s,0);
    setStageIPH(s, iphOf(s, getLvl(s)));
    document.getElementById(`${s}_btn`).onclick = ()=> upgrade(s);
  });

  // –ø–æ–¥—Å–∫–∞–∑–∫–∞: —Ç—É—Ç –º—ã –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Å—Å–∏–≤ –≤ –±–∞–ª–∞–Ω—Å (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ç–∏–∫),
  // —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI. –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —É —Ç–µ–±—è —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö.
  refreshAll();

  // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–∏—Ö –ø–ª–∞—à–µ–∫ —Ä–∞–∑ –≤ 2 —Å–µ–∫ (–≤–∏–∑—É–∞–ª—å–Ω—ã–π –∞–ø–¥–µ–π—Ç)
  setInterval(refreshTopBars, 2000);

</script>
</body>
</html>

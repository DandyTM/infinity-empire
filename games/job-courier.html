<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>I.Deliv — Курьер</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
/* ===== copied/compatible styles from taxi + courier specifics ===== */
:root{
  --bg:#efefef;
  --card:#fff;
  --muted:#666;
  --accent:#FFD200;
  --text:#111;
  --shadow: 0 10px 26px rgba(0,0,0,.18);
}
[data-theme="dark"]{
  --bg:#0f0f11;
  --card:#121214;
  --muted:#bdbdbd;
  --accent:#FFD200;
  --text:#f7f7f7;
  --shadow: 0 12px 36px rgba(0,0,0,.6);
}
[data-theme="dark"] .transport-card{
  background:rgba(18,18,20,0.92);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}

/* background images (exactly as in taxi) */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url("moscow.png") center/cover no-repeat;
  filter: blur(8px) brightness(0.75);
  z-index: -1;
  pointer-events: none;
  transition: background 0.4s ease, filter 0.4s ease;
}
[data-theme="dark"] body::before {
  background: url("moscow_night.png") center/cover no-repeat;
  filter: blur(8px) brightness(0.45);
}

/* HEADER (exactly like taxi) */
.header{
  position:fixed; top:0; left:0; right:0;
  display:flex; align-items:center; justify-content:center;
  padding:12px 18px; background:var(--card);
  border-bottom:1px solid rgba(0,0,0,.06); z-index:1200;
  box-shadow: var(--shadow);
}
.header img.logo{height:46px; display:block;}
.header .left, .header .right{position:absolute; top:10px; display:flex; gap:10px; align-items:center;}
.header .left{left:14px;}
.header .right{right:14px;}
.header-btn{
  background:var(--card); border:1px solid rgba(0,0,0,.08);
  padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  color:var(--text);
}

/* rating badge */
#ratingBox{
  background:var(--card);
  border-radius:10px;
  padding:8px 10px;
  font-size:14px;font-weight:700;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  display:flex; flex-direction:column; align-items:flex-start;
  gap:4px;
  color:var(--text);
}

/* theme switch */
.theme-toggle{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px; border-radius:14px; cursor:pointer;
}
.switch{
  width:46px; height:26px; border-radius:16px; display:inline-block; position:relative;
  background:#222; border:2px solid rgba(0,0,0,.08);
}
.switch .knob{
  position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%;
  background:#fff; transition:all .18s ease;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
[data-theme="dark"] .switch{ background:var(--accent); border-color:rgba(0,0,0,.25); }
[data-theme="dark"] .switch .knob{ left:22px; background:#111; }

/* TASK PANEL + LEVEL BOX (kept from taxi styling) */
#taskPanel{
  margin:86px auto 14px;
  width:90%; max-width:720px;
  background:var(--accent); color:#111;
  padding:12px 16px; border-radius:14px; font-weight:700; text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}
#levelBlock{
  position: fixed;
  top: 100px;
  right: 18px;
  width: 250px;
  background: var(--card);
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 10px 14px;
  z-index: 3000;
}
#xpBarWrapper{width:100%;height:8px;background:rgba(0,0,0,.14);border-radius:8px;overflow:hidden;margin-top:6px;}
#xpBar{height:100%;background:var(--accent);width:0%;transition:.25s;}
#xpText{font-size:12px;color:var(--muted);text-align:right;}

/* ORDERS LIST */
/* ORDERS LIST */
#goalBox {
  position: fixed;
  top: 100px;
  left: 20px;

  width: 230px;
  padding: 14px 18px;

  background: #ffffffea;
  backdrop-filter: blur(6px);
  border-radius: 14px;
  box-shadow: 0 4px 18px rgba(0,0,0,0.18);

  transition: width .25s ease, height .25s ease;
  z-index: 9999;
}

/* Развёрнутая панель */
#goalBox.expanded {
  width: 360px;
}

#orderList {
  margin-top: 130px;
  width: 720px;         /* фиксируем контейнер */
  margin-left: auto;    /* центрируем */
  margin-right: auto;   /* центрируем */
}





#orderList, #goalBox {
  transition: margin-left .22s ease, width .22s ease, transform .22s ease;
}





/* Order card a bit taller as requested */
.order-card{
  width: 100%;
  max-width: 720px;
  background:var(--card);
  border-radius:14px;
  padding:18px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  box-shadow:var(--shadow);
  transition:transform .18s, box-shadow .18s;
}

.order-card:hover{ transform:translateY(-6px); box-shadow: 0 18px 50px rgba(0,0,0,.22); }
.order-card .meta{opacity:.85; color:var(--muted); font-weight:600;}
.take-btn{
  background:var(--accent); border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}

/* ACTIVE ORDER (bottom) - taxi style road, with static transport icon to the left */
#activeOrderBox{
  position:fixed; left:0; right:0; bottom:18px;
  margin:0 auto; width:94%; max-width:960px;
  background:var(--card); padding:14px; border-radius:14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.28); display:none; z-index:1100;
}
#activeOrderBox .title{font-weight:800; margin-bottom:6px;}
/* layout: icon + road */
#activeRow{ display:flex; align-items:center; gap:12px; }
#transportStatic { width:48px; height:48px; object-fit:contain; border-radius:8px; }
/* road */
#roadWrapper{ position:relative; flex:1; height:28px; background:rgba(0,0,0,.06); border-radius:999px; overflow:hidden;}
#roadProgress{ height:100%; background:var(--accent); width:0%; transition: width .12s linear; border-radius:999px;}
#currentKmText{ margin-top:8px; color:var(--muted); }
#currentPayText{ margin-top:6px; font-weight:800; }

/* MODALS & small utilities */
.modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:2000; backdrop-filter: blur(4px); }
.modal{ width:92%; max-width:520px; border-radius:18px; background:var(--card); padding:16px; box-shadow:var(--shadow); }
.hidden{ display:none !important; }

/* SHIFT SUMMARY modal (copied look from taxi) */
.summary-row{ padding:8px 0; border-bottom:1px solid rgba(0,0,0,.06); font-weight:600; color:var(--muted); }

/* animations */
#orderCard, #activeOrderBox, .modal { animation: fadeInUp .28s ease forwards; opacity:0; transform:translateY(18px); }
@keyframes fadeInUp { to { opacity:1; transform:translateY(0); } }

/* responsive tweaks */
@media(max-width:640px){
  #levelBlock{ width:200px; right:8px; }
  .order-card{ width:95% }
  #activeOrderBox{ width:96% }
}

/* transport list styles + hover animation */
.transport-card{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px; border-radius:12px;
  background:var(--card);
  cursor:pointer;
  transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
  gap:12px;
}

.transport-card:hover{
  transform:translateY(-4px) scale(1.01);
  box-shadow:0 14px 34px rgba(0,0,0,.18);
}
.transport-card img {
  width:44px; height:44px; object-fit:contain; transition: transform .18s ease;
}
.transport-card:hover img { transform: scale(1.06); }
.transport-card .transport-name{ font-weight:800; font-size:16px; }
.transport-card .transport-locked{ color:#ff6f6f; font-size:13px; margin-top:6px; font-weight:700; }

/* selected */
.transport-card.selected{
  background:var(--accent);
  color:#111;
  box-shadow:0 14px 44px rgba(0,0,0,.25);
}
.transport-card .selected-badge{
  font-weight:800; color:#111;
}

/* small utilities */
.center{ text-align:center; }
.money-fly {
  position: fixed;
  font-weight: 800;
  font-size: 22px;
  color: var(--accent);
  pointer-events: none;
  z-index: 5000; /* ← теперь поверх всех модалок и хедера */
  animation: flyUp 1s ease forwards;
}
@keyframes flyUp {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  80% { transform: translateY(-65px) scale(1.35); opacity: 1; }
  100% { transform: translateY(-95px) scale(1); opacity: 0; }
}

/* small helper for muted small text */
.small{ color:var(--muted); font-size:13px; }


/* === Ограничение высоты окна закрытия смены === */
#shiftSummary .modal, #shiftSummaryContent {
  max-height: 80vh !important;
  overflow-y: auto !important;
}

.hidden{
  display:none !important;
}
#goalSmallText {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  line-height: 1.35;
}

#goalSmallText b {
  font-size: 16px;
  font-weight: 800;
}

#goalDescription {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  opacity: 0.9;
  line-height: 1.35;
}

</style>
</head>
<body>

<!-- HEADER copied from taxi (exact look) -->
<div class="header">
  <div class="left">
    <div id="ratingBox">
      <div id="ratingView">⭐ 0.00 (0)</div>
      <div id="orderCountView" style="font-weight:600;color:var(--muted)">Доставок: 0</div>
    </div>
  </div>

  <img class="logo" src="./icons/infinity_go.png" alt="INFINITY GO">

  <div class="right">
    <button id="openProfileBtn" class="header-btn">Профиль</button>
    <button id="endShiftVisible" class="header-btn">Завершить смену</button>
    <button id="exitVisible" class="header-btn">Выйти</button>

    <div class="theme-toggle" id="themeToggle" title="Тема">
      <div style="font-size:13px; font-weight:700;">Тема</div>
      <div class="switch" id="themeSwitch"><div class="knob"></div></div>
    </div>
  </div>
</div>

<!-- TASK & LEVEL -->
<!-- GOAL PANEL -->
<div id="goalBox" class="collapsed">
  <div id="goalSmallText">Текущая цель:<br><b>отсутствует</b></div>

  <div id="goalExpanded" class="hidden" style="margin-top:8px;">
    <div id="goalDescription" style="margin-bottom:12px;"></div>
    <div id="goalChoices" class="hidden"></div>
  </div>
</div>

<div id="levelBlock">
  <div id="levelView" style="font-weight:800; font-size:18px;">Новичок</div>

  <div id="balanceInLevel" style="margin-top:4px; font-weight:700; font-size:16px;">
    Баланс: 0 ₽
  </div>
  <div id="rentTimer" style="margin-top:4px; font-size:14px; color:var(--muted);"></div>

  <div id="xpBarWrapper" style="margin-top:8px;">
    <div id="xpBar"></div>
  </div>
  <div id="xpText">0 / 120 XP</div>
</div>


<!-- TRANSPORT SELECT (always visible until 'Выйти на линию') -->
<div id="transportModal" class="modal-back">
  <div class="modal" style="max-width:520px;">
    <h2 style="margin-bottom:12px;">Выберите способ передвижения</h2>
    <div id="transportList"></div>
    <button id="exitJobBtn" class="header-btn" style="width:100%;margin-top:8px;background:#ff6b6b;border-color:rgba(0,0,0,.08);">Выйти</button>
    <button id="transportConfirm" class="header-btn" style="width:100%;margin-top:8px;background:var(--accent);">Выйти на линию</button>
  </div>
</div>
<!-- МОДАЛ ВЫБОРА МОДЕЛЕЙ -->
<div id="modelSelectModal" class="modal-back hidden">
  <div class="modal" style="max-width:540px;">
    <h2 id="modelSelectTitle">Выбор модели</h2>
    <div id="modelList" style="margin-top:12px;display:flex;flex-direction:column;gap:12px;"></div>
    <div style="margin-top:14px;" class="center">
      <button id="closeModelSelect" class="header-btn" style="background:var(--accent);width:100%;">Закрыть</button>
    </div>
  </div>
</div>

<!-- Orders list (only one order displayed at time by logic) -->
<div id="orderList"></div>

<!-- Active order (bottom) with taxi-like progress -->
<div id="activeOrderBox">
  <div class="title">Активный заказ</div>
  <div id="currentRoute" style="font-weight:700;margin-bottom:8px;"></div>

  <div id="activeRow">
    <img id="transportStatic" src="./icons/case.png" alt="transport">
    <div id="roadWrapper">
      <div id="roadProgress"></div>
    </div>
  </div>

  <div id="currentKmText" style="margin-top:8px;color:var(--muted)"></div>
  <div id="currentPayText" style="margin-top:6px;font-weight:800;"></div>
  <div id="nextOrderBox" class="hidden" style="margin-top:10px;"></div>
</div>

<!-- SHIFT SUMMARY modal -->
<div id="shiftSummary" class="modal-back hidden">
  <div class="modal" id="shiftSummaryContent">
    <h2>Смена завершена</h2>
    <div id="summaryList"></div>
    <h3 style="margin-top:12px">Итого на баланс: <span id="sumTotal">0</span> ₽</h3>
    <div class="center" style="margin-top:12px;"><button class="header-btn" id="closeShiftBtn" style="background:var(--accent);">Ок</button></div>
  </div>
</div>

<!-- PROFILE (copied structure from taxi profile, exact look) -->
<div id="profileModal" class="modal-back hidden">
  <div class="modal" id="profileContent">
    <h2>Профиль курьера</h2>
    <div class="profRow"><b>Рейтинг:</b> <span id="profRating">⭐ 0.00 (0)</span></div>
    <div class="profRow"><b>Выполнено доставок:</b> <span id="profOrders">0</span></div>
    <div class="profRow"><b>Уровень:</b> <span id="profLvl">1</span></div>
    <div class="profRow"><b>Опыт:</b> <span id="profXP">0</span></div>
    <div class="profRow"><b>Баланс:</b> <span id="profMoney">0</span> ₽</div>
    <div class="profRow"><b>Пробег:</b> <span id="profKm">0</span> км</div>

    <div style="margin-top:12px;">
      <button id="openTransportFromProfile" class="header-btn" style="width:100%;margin-bottom:8px;">Выбрать транспорт</button>
    </div>

    <h3 style="margin-top:12px;">Последние заказы доставки</h3>
    <div id="profHistory" style="max-height:200px; overflow-y:auto; margin-top:8px;"></div>

    <h3 style="margin-top:12px;">Отзывы клиентов</h3>
    <div id="profReviews" style="max-height:160px; overflow-y:auto; margin-top:8px;"></div>

    <div style="margin-top:12px;" class="center">
      <button id="closeProfile" class="header-btn" style="background:var(--accent);">Закрыть</button>
    </div>
  </div>
</div>

<audio id="orderSound" src="yandex.mp3"></audio>

<script>
/* -------------------------
  State + persistence
-------------------------*/
  // helpers compatible with main game: read/write amounts in RUB under key+'_rub'
  function readRub(k){ return parseFloat(localStorage.getItem(k+'_rub')) || 0; }
  function writeRub(k, v){ localStorage.setItem(k+'_rub', v); }

let balance = readRub('balance') || 0;
let ratingScore = +localStorage.getItem('courier_ratingScore') || 0;
let ratingCount = +localStorage.getItem('courier_ratingCount') || 0;
let completed = +localStorage.getItem('courier_completed') || 0;
let level = +localStorage.getItem('courier_level') || 1;
let xp = +localStorage.getItem('courier_xp') || 0;
let activeGoal = JSON.parse(localStorage.getItem('activeGoal') || 'null');


const titles = ["Новичок","Профи","Эксперт","Топ-курьер"];
const xpNeedArr = [210,1470,6000,999999];
function xpNeed(){ return xpNeedArr[Math.min(level-1, xpNeedArr.length-1)]; }

/* speeds */
const speed = { walk:3, bike:1.8, moto:1.8, car:0.8 }; // bike and moto same coef as вы просили

/* transports available (levels: walk=1, others unlock at 2) */
/* NOTE: icons filenames are taken from ./icons folder as you requested */
const transports = [
  {type:"walk", icon:"case.png", name:"Пешком", req:1},
  {type:"bike", icon:"yandexbike.png", name:"Электровело", req:2},
  {type:"moto", icon:"scooter.png", name:"Мото", req:2},
  {type:"car", icon:"auto.png", name:"Авто", req:2}
];

/* ===== МОДЕЛИ ТРАНСПОРТА (Только аренда — покупка убрана) ===== */
const transportModels = {
  bike: [
    {name:"Yandex E-Bike", rent:700, mul:1.10, icon:"bike_yandex.png"},
    {name:"Xiaomi Himo C26", rent:900, mul:1.13, icon:"bike_himo.png"},
    {name:"Kugoo V3 Pro", rent:1200, mul:1.16, icon:"bike_kugoo.png"}
  ],
  moto: [
    {name:"Honda Dio 50cc", rent:1500, mul:1.20, icon:"moto_dio.png"},
    {name:"Yamaha Jog 3KJ", rent:1800, mul:1.25, icon:"moto_jog.png"},
    {name:"Honda Super Cub", rent:2300, mul:1.30, icon:"moto_cub.png"}
  ],
  car: [
    {name:"Daewoo Matiz 0.8", rent:2500, mul:1.35, icon:"car_matiz.png"},
    {name:"Lada Granta Sedan", rent:3800, mul:1.45, icon:"car_granta.png"},
    {name:"Kia Rio (III)", rent:7500, mul:1.60, icon:"car_rio.png"}
  ]
};

/* Хранилище арендованных моделей: структура { bike: {0: expires, 1: expires}, moto: {...}, car: {...} } */
let rentedModels = JSON.parse(localStorage.getItem('rentedModels') || '{}');

/* Активная модель (если есть) — {type: 'bike', index: 1, expires: ...? } или null */
let activeModel = JSON.parse(localStorage.getItem('activeModel') || 'null');

/* Переменные игры */
let transport = null;            // active transport type (used during delivery)
let selectedTransport = null;    // selection in modal
let orderActive = false;         // only one order at a time
let current = null;              // current order object

/* UI update helpers */
function saveAll(){
  writeRub('balance', balance);
  localStorage.setItem('courier_ratingScore', ratingScore);
  localStorage.setItem('courier_ratingCount', ratingCount);
  localStorage.setItem('courier_completed', completed);
  localStorage.setItem('courier_level', level);
  localStorage.setItem('courier_xp', xp);
  localStorage.setItem('rentedModels', JSON.stringify(rentedModels));
  localStorage.setItem('activeModel', JSON.stringify(activeModel));
}
function updateUI(){
  const avg = ratingCount ? (ratingScore / ratingCount).toFixed(2) : '0.00';
  document.getElementById('ratingView').textContent = `⭐ ${avg} (${ratingCount})`;
  document.getElementById('orderCountView').textContent = 'Доставок: ' + (localStorage.getItem('completed_orders')||completed);
  document.getElementById('levelView').textContent = titles[Math.min(level-1, titles.length-1)];
  document.getElementById('xpText').textContent = `${xp} / ${xpNeed()} ⚡`;
  document.getElementById('balanceInLevel').textContent = "Баланс: " + balance + " ₽";
  // update rent timer immediately
  updateRentTimer();
  saveAll();
  updateGoalUI();
}
updateUI();
function updateGoalUI(){
  const small = document.getElementById("goalSmallText");
  const desc = document.getElementById("goalDescription");

  if(!activeGoal){
    small.innerHTML = "Текущая цель:<br><b>отсутствует</b>";
    return;
  }

  if(activeGoal.type === "orders"){
    small.innerHTML = `Текущая цель:<br>заказов ${activeGoal.progress}/${activeGoal.need} (+${activeGoal.reward} ₽)`;
    desc.innerHTML = `Выполните <b>${activeGoal.need}</b> заказов, чтобы получить <b>${activeGoal.reward} ₽</b>.`;
  } else {
    small.innerHTML = `Текущая цель:<br>${Math.round(activeGoal.progress)}/${activeGoal.need} км (+${activeGoal.reward} ₽)`;
    desc.innerHTML = `Преодолейте <b>${activeGoal.need} км</b>, чтобы получить <b>${activeGoal.reward} ₽</b>.`;
  }
}
document.getElementById("goalBox").onclick = ()=>{
  const box = document.getElementById("goalBox");
  const expanded = document.getElementById("goalExpanded");
  const choices = document.getElementById("goalChoices");

  // если цель уже выбрана — просто показать текст цели, НО не выводить выбор снова
  if(activeGoal){
    choices.classList.add("hidden"); // скрываем варианты
    expanded.classList.toggle("hidden");
    box.classList.toggle("expanded");
    return;
  }

  // если цели нет — показываем выбор
  expanded.classList.remove("hidden");
  box.classList.add("expanded");
  choices.classList.remove("hidden");
  choices.innerHTML = "";

  randomGoals().forEach(g=>{
    const div = document.createElement("div");
    div.style.marginBottom = "8px";
    div.style.padding = "8px";
    div.style.border = "1px solid rgba(0,0,0,.15)";
    div.style.borderRadius = "10px";
    div.style.cursor = "pointer";
    div.innerHTML = (g.type==="orders")
      ? `${g.need} заказов (+${g.reward} ₽)`
      : `Преодолей ${g.need} км (+${g.reward} ₽)`;

    div.onclick = ()=>{
      activeGoal = g;
      localStorage.setItem('activeGoal', JSON.stringify(activeGoal));
      expanded.classList.add("hidden");
      box.classList.remove("expanded");
      updateGoalUI();
    };

    choices.appendChild(div);
  });
};


/* Play sound when new order arrives (only on appear) */
function playSound(){
  const a = document.getElementById('orderSound');
  if(a){ try{ a.currentTime = 0; a.play().catch(()=>{}); }catch(e){} }
}

/* THEME handling (persist) */
(function(){
  const saved = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved === 'dark' ? 'dark' : 'light');
  if(saved === 'dark') document.querySelector('.switch .knob').style.left='22px';
  document.getElementById('themeToggle').onclick = () => {
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
    if(cur === 'dark') document.querySelector('.switch .knob').style.left='22px';
    else document.querySelector('.switch .knob').style.left='2px';
  };
})();

/* TRANSPORT DRAW + selection (uses images from ./icons) */
function drawTransport(){
  const box = document.getElementById('transportList');
  box.innerHTML = '';
  transports.forEach(t=>{
    const locked = level < t.req;
    const card = document.createElement('div');
    card.className = 'transport-card';
    if(selectedTransport === t.type) card.classList.add('selected');

    const iconPath = `./icons/${t.icon}`;
    const leftHTML = `<div style="display:flex;align-items:center;gap:14px;">
      <img src="${iconPath}" alt="${t.name}">
      <div>
        <div class="transport-name">${t.name}</div>
        ${locked ? `<div class="transport-locked">Доступно с уровня ${t.req}</div>` : ""}
      </div>
    </div>`;

    const rightHTML = selectedTransport === t.type
      ? `<div class="selected-badge">Выбрано</div>`
      : `<div style="color:var(--muted);font-weight:700">${locked ? '' : ''}</div>`;

    card.innerHTML = leftHTML + rightHTML;

    if(!locked){
      card.onclick = ()=> {
        // Пешком всегда можно выбрать
        selectedTransport = t.type;
        drawTransport();
      };
      card.style.opacity = '1';
      card.style.cursor = 'pointer';
    } else {
      card.style.opacity = '.45';
      card.style.cursor = 'not-allowed';
    }

    box.appendChild(card);
  });
}
drawTransport();

/* Модели: рисуем доступные только арендуемые модели (покупки нет) */
function drawModels(type){
  document.getElementById('modelSelectTitle').textContent = "Выбор модели — " + (type || '').toUpperCase();
  const box = document.getElementById('modelList');
  box.innerHTML = '';

  // special case: if type is walk — no models: just use walk
  if(type === 'walk'){
    const div = document.createElement('div');
    div.className = 'transport-card';
    div.innerHTML = `<div style="flex:1;font-weight:700">Пешком — без модели</div>
      <div><button class="take-btn" onclick="useWalk()">Использовать</button></div>`;
    box.appendChild(div);
    return;
  }

  (transportModels[type] || []).forEach((m,i)=>{
    const rented = rentedModels[type] && rentedModels[type][i] && rentedModels[type][i] > Date.now();
    const isActive = activeModel && activeModel.type === type && activeModel.index === i;
    const div = document.createElement('div');
    div.className = 'transport-card';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:14px;">
        <img src="./icons/${m.icon}" style="width:48px;height:48px;" alt="${m.name}">
        <div>
          <div class="transport-name">${m.name}</div>
          </div>
      </div>
      <div>
        ${
          isActive ? `<div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;"><div class="selected-badge">Активно</div><button class="take-btn" onclick="useModel('${type}',${i})">Выбрать</button></div>` :
          rented ? `<button class="take-btn" onclick="useModel('${type}',${i})">Использовать (Аренда)</button>` :
          `<button class="take-btn" onclick="rentModel('${type}',${i})">Аренда ${m.rent} ₽</button>`
        }
      </div>
    `;
    box.appendChild(div);
  });
}

/* transport confirm button — открывает модальное моделей для выбранного транспорта,
   но если выбран walk — сразу выходим на линию */
document.getElementById('transportConfirm').onclick = ()=>{
  if(!selectedTransport){
    // gentle hint
    const d = document.createElement('div');
    d.textContent = 'Выберите транспорт';
    d.style.position='fixed'; d.style.bottom='120px'; d.style.left='50%'; d.style.transform='translateX(-50%)';
    d.style.background='var(--card)'; d.style.padding='10px 14px'; d.style.borderRadius='12px'; d.style.boxShadow='0 8px 26px rgba(0,0,0,.18)';
    document.body.appendChild(d); setTimeout(()=>d.remove(),1400);
    return;
  }

  // if walk selected — go directly on shift as walk (no models)
  if(selectedTransport === 'walk'){
    transport = 'walk';
    activeModel = null; // no model for walk
    localStorage.removeItem('activeModel');
    setTransportStaticImage('walk');
    document.getElementById('transportModal').classList.add('hidden');
    setTimeout(()=> newOrder(), 160);
    updateUI();
    return;
  }

  // otherwise open model selection modal for that transport type
  transport = selectedTransport;
  drawModels(transport);
  document.getElementById('modelSelectModal').classList.remove('hidden');
};

/* rent a model (30 min) */
function rentModel(type,i){
  const m = transportModels[type][i];
  if(balance < m.rent){
    const d = document.createElement('div'); d.textContent='Недостаточно средств'; d.style.position='fixed'; d.style.bottom='120px'; d.style.left='50%'; d.style.transform='translateX(-50%)'; d.style.background='var(--card)'; d.style.padding='10px 14px'; d.style.borderRadius='12px'; d.style.boxShadow='0 8px 26px rgba(0,0,0,.18)'; document.body.appendChild(d); setTimeout(()=>d.remove(),1400);
    return;
  }
  balance -= m.rent;
  rentedModels[type] = rentedModels[type] || {};
  rentedModels[type][i] = Date.now() + 30*60*1000; // 30 мин
  saveAll();
  drawModels(type);
  updateUI();
}

/* use a model (after renting) */
function useModel(type,i){
  // check rent expiry
  const expires = (rentedModels[type] && rentedModels[type][i]) || 0;
  if(expires <= Date.now()){
    const d = document.createElement('div'); d.textContent='Аренда истекла'; d.style.position='fixed'; d.style.bottom='120px'; d.style.left='50%'; d.style.transform='translateX(-50%)'; d.style.background='var(--card)'; d.style.padding='10px 14px'; d.style.borderRadius='12px'; d.style.boxShadow='0 8px 26px rgba(0,0,0,.18)'; document.body.appendChild(d); setTimeout(()=>d.remove(),1400);
    drawModels(type);
    return;
  }
  activeModel = {type, index: i, expires};
  localStorage.setItem('activeModel', JSON.stringify(activeModel));
  transport = type;
  setTransportStaticImage(type, i);
  // close only model select, keep transportModal hidden behavior but ensure UI updated
  document.getElementById('modelSelectModal').classList.add('hidden');
  document.getElementById('transportModal').classList.add('hidden');
  drawModels(type); // update model buttons to reflect active state
  updateUI();
  setTimeout(()=> newOrder(), 160);
}

/* use walk quick helper */
function useWalk(){
  transport = 'walk';
  activeModel = null;
  localStorage.removeItem('activeModel');
  setTransportStaticImage('walk');
  document.getElementById('modelSelectModal').classList.add('hidden');
  document.getElementById('transportModal').classList.add('hidden');
  updateUI();
  setTimeout(()=> newOrder(), 160);
}

/* ORDER generation (only one at time) */
const froms=[
  "ПВЗ Ozon, Сущёвский Вал 5",
  "ПВЗ WB, Павелецкая пл. 2",
  "KFC, Тверская 9",
  "Аптека 36.6, Цветной б-р 13",
  "McDonald's, Курская пл. 1"
];

const tos=[
  "ул. Бауманская, 27",
  "ул. Арбат, 14/1",
  "ул. Сретенка, 22",
  "ул. Покровка, 45",
  "пр-т Мира, 68"
];

function genOrder(){
  const A = froms[Math.floor(Math.random()*froms.length)];
  const B = tos[Math.floor(Math.random()*tos.length)];

  // диапазоны для расстояния по транспорту
  let distMin = 0.3, distMax = 3; // пеший
  if (transport === "bike" || transport === "moto"){ distMin = 1; distMax = 7; }
  if (transport === "moto"){ distMin = 1.5; distMax = 9; } // moto same coef but can have larger max in second line (we keep min override)
  if (transport === "car"){ distMin = 2.5; distMax = 15; }

  const dist = +(distMin + Math.random()*(distMax - distMin)).toFixed(1);

  // коэффициенты оплаты (базовый)
  let coef = 1;
  if (transport === "bike") coef = 1.2;
  if (transport === "moto") coef = 1.2;
  if (transport === "car") coef = 1.4;

  // базовая цена * расстояние * коэффициент
  let pay = dist * 50 * coef;
  // применяем множитель активной модели (если есть и аренда активна)
  if(activeModel && activeModel.type && typeof activeModel.index !== 'undefined'){
    const tm = transportModels[activeModel.type][activeModel.index];
    if(tm && (rentedModels[activeModel.type] && rentedModels[activeModel.type][activeModel.index] > Date.now())){
      // pay multiplier removed; only affects speed
    } else {
      // если аренда истекла — сбросим activeModel
      activeModel = null;
      localStorage.removeItem('activeModel');
    }
  }

  // округляем к целым ₽, но не "делаем красивые" — как просили
  pay = Math.round(pay);

  // XP всегда +3
  const xpGain = 3;

  return {A,B,dist,pay,xpGain, time: Date.now()};
}

/* show single order card (bigger) */
function newOrder(){
  // if currently delivering or order exists, skip (only one allowed)
  if(orderActive || document.getElementById('activeOrderBox').style.display === 'block') return;
  current = genOrder();
  const box = document.getElementById('orderList');
  box.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'order-card';
  card.innerHTML = `
    <div style="flex:1;">
      <div style="font-size:20px;font-weight:800">${current.A}</div>
      <div style="font-size:20px;font-weight:800;margin-top:6px">→ ${current.B}</div>
      <div style="color:var(--muted);margin-top:8px;font-weight:600">${current.dist} км • ${current.pay} ₽ • +${current.xpGain}⚡</div>
    </div>
    <div style="margin-left:16px">
      <button class="take-btn" id="takeBtn">Взять</button>
    </div>
  `;
  box.appendChild(card);
  playSound(); // sound on appear

  document.getElementById('takeBtn').onclick = ()=> {
    // start delivery only if transport chosen
    if(!transport){
      const d = document.createElement('div'); d.textContent='Выберите транспорт'; d.style.position='fixed'; d.style.bottom='120px'; d.style.left='50%'; d.style.transform='translateX(-50%)'; d.style.background='var(--card)'; d.style.padding='10px 14px'; d.style.borderRadius='12px'; d.style.boxShadow='0 8px 26px rgba(0,0,0,.18)'; document.body.appendChild(d); setTimeout(()=>d.remove(),1400);
      document.getElementById('transportModal').classList.remove('hidden');
      return;
    }
    box.innerHTML = ''; // remove order card from list (only one at time)
    startDelivery();
  };
  orderActive = true;
}

/* Set static transport image to left of road */
function setTransportStaticImage(type, index){
  const map = {
    walk: './icons/walker.png',
    bike: './icons/yandexbike.png',
    moto: './icons/scooter.png',
    car: './icons/auto.png'
  };
  // if activeModel with specific icon, prefer it (if available)
  if(index !== undefined && type && transportModels[type] && transportModels[type][index]){
    const icon = transportModels[type][index].icon;
    if(icon) map[type] = './icons/' + icon;
  }
  const el = document.getElementById('transportStatic');
  if(el && map[type]) el.src = map[type];
}

/* DELIVERY: progress with roadProgress only (no moving icon) */
let animHandle = null;
function startDelivery(){
  // ensure static image matches selected transport (if model active, show its icon)
  if(activeModel) setTransportStaticImage(activeModel.type, activeModel.index);
  else setTransportStaticImage(transport);

  document.getElementById('activeOrderBox').style.display = 'block';
  document.getElementById('currentRoute').textContent = current.A + ' → ' + current.B;
  document.getElementById('currentPayText').textContent = current.pay + ' ₽';
  document.getElementById('currentKmText').textContent = `Прогресс: 0 / ${current.dist} км`;
  document.getElementById('roadProgress').style.width = '0%';

  // compute duration using speed mapping; ensure minimum time
  const sp = speed[transport] || 3;
  const duration = Math.max(2200, Math.round(current.dist * sp * 1000)); // ms

  const start = performance.now();
  function frame(now){
    const p = Math.min((now - start) / duration, 1);
    const pct = p * 100;
    document.getElementById('roadProgress').style.width = pct + '%';
    document.getElementById('currentKmText').textContent = `Прогресс: ${ (current.dist * p).toFixed(1) } / ${current.dist} км`;
    if(p < 1) animHandle = requestAnimationFrame(frame);
    else {
      cancelAnimationFrame(animHandle);
      finishDelivery();
    }
  }
  animHandle = requestAnimationFrame(frame);
}

function showMoneyFly(amount){
  const el = document.createElement('div');
  el.className = 'money-fly';
  el.textContent = `+${amount} ₽`;

  const lb = document.getElementById('levelBlock');
  const rect = lb.getBoundingClientRect();

  // вертикальная корректировка, чтобы не улетало под хедер
  const yOffset = window.scrollY + rect.top - 10;
  const xOffset = rect.left + 20;

  el.style.left = xOffset + 'px';
  el.style.top = yOffset + 'px';

  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 1200);
}
function randomGoals(){
  return [
    {type:"orders", need:25 + Math.floor(Math.random()*20), reward:2000 + Math.floor(Math.random()*3000), progress:0},
    {type:"orders", need:10 + Math.floor(Math.random()*15), reward:1000 + Math.floor(Math.random()*2000), progress:0},
    {type:"distance", need:50 + Math.floor(Math.random()*100), reward:2500 + Math.floor(Math.random()*3500), progress:0}
  ];
}

/* FINISH delivery: award and prepare next order */
function finishDelivery(){
  // smooth hide like taxi
  const active = document.getElementById('activeOrderBox');
  active.style.opacity = 0;
  setTimeout(()=>{
    active.style.display = 'none';
    active.style.opacity = 1;
    // record stats
    completed++;
    balance += current.pay;
    showMoneyFly(current.pay);
    if(activeGoal){
  if(activeGoal.type === "orders"){
    activeGoal.progress++;
  } else if(activeGoal.type === "distance"){
    activeGoal.progress += current.dist;
  }

  if(activeGoal.progress >= activeGoal.need){
    balance += activeGoal.reward;
    showMoneyFly(activeGoal.reward);
    activeGoal = null;
    localStorage.removeItem('activeGoal');
  } else {
    localStorage.setItem('activeGoal', JSON.stringify(activeGoal));
  }
  updateGoalUI();
}

    // добавляем пробег
    let totalKm = parseFloat(localStorage.getItem('total_km')||'0');
    totalKm += current.dist;
    localStorage.setItem('total_km', totalKm.toFixed(2));
    xp += current.xpGain;
    // level up
    while(xp >= xpNeed()){
      xp -= xpNeed();
      level++;
    }
    // rating increment (simple random)
    const addStars = Math.random() < 0.85 ? 5 : 4;
    ratingScore += addStars; ratingCount++;

    // persisted counters
    localStorage.setItem('completed_orders', (+localStorage.getItem('completed_orders')||0) + 1);
    saveAll();

    // save to trips_history for profile/shift summary
    let trips = JSON.parse(localStorage.getItem('trips_history') || '[]');
    trips.push(current);
    localStorage.setItem('trips_history', JSON.stringify(trips));

    updateUI();
    orderActive = false;
    current = null;

    // auto spawn next order after small delay (keeps selected transport)
    setTimeout(()=> newOrder(), 600);
  }, 240);
}

/* PROFILE modal open/close (copied functional behavior) */
document.getElementById('openProfileBtn').onclick = function(){
  const ratingAvg = ratingCount>0 ? (ratingScore / ratingCount).toFixed(2) : '0.00';
  document.getElementById('profRating').textContent = `⭐ ${ratingAvg} (${ratingCount})`;
  document.getElementById('profOrders').textContent = completed;
  document.getElementById('profLvl').textContent = level;
  document.getElementById('profXP').textContent = xp;
  document.getElementById('profMoney').textContent = balance;
  document.getElementById('profKm').textContent = Math.round(+localStorage.getItem('total_km') || 0);

  // history — последнее из trips_history (доставки)
  const hist = JSON.parse(localStorage.getItem('trips_history') || '[]');
  const hbox = document.getElementById('profHistory'); hbox.innerHTML = '';
  if(hist.length === 0) hbox.innerHTML = '<div class="small">Заказов пока нет</div>';
  else hist.slice(-12).reverse().forEach(t => {
    hbox.innerHTML += `<div class="profRow">${t.A} → ${t.B} • ${t.dist} км • ${t.pay} ₽</div>`;
  });

  const rev = JSON.parse(localStorage.getItem('reviews') || '[]');
  const rbox = document.getElementById('profReviews'); rbox.innerHTML = '';
  if(rev.length === 0) rbox.innerHTML = '<div class="small">Отзывы отсутствуют</div>';
  else rev.slice(-20).reverse().forEach(r=>{
    rbox.innerHTML += `<div style="padding:8px 0;border-bottom:1px solid rgba(0,0,0,.06)"><b>⭐ ${r.stars}</b> <div class="small">${r.text}</div></div>`;
  });

  document.getElementById('profileModal').classList.remove('hidden');
};
document.getElementById('closeProfile').onclick = ()=> document.getElementById('profileModal').classList.add('hidden');

/* профиль: кнопка открыть транспорт */
document.getElementById('openTransportFromProfile').onclick = ()=>{
  document.getElementById('profileModal').classList.add('hidden');
  selectedTransport = null;
  drawTransport();
  document.getElementById('transportModal').classList.remove('hidden');
};

/* END SHIFT / EXIT: show shift summary modal (like taxi), instead of immediate redirect */
document.getElementById('endShiftVisible').onclick = ()=> {
  // prepare summary from trips_history
  const trips = JSON.parse(localStorage.getItem('trips_history') || '[]');
  const box = document.getElementById('summaryList');
  box.innerHTML = '';
  let total = 0;
  if(trips.length === 0) box.innerHTML = '<div class="small">За смену поездок не было</div>';
  trips.forEach(t=>{
    box.innerHTML += `<div class="summary-row">${t.A} → ${t.B} • ${t.dist} км • ${t.pay} ₽</div>`;
    total += (t.pay||0);
  });
  document.getElementById('sumTotal').textContent = total;
  // show modal
  document.getElementById('shiftSummary').classList.remove('hidden');
};

// close summary and reset session shift data (but keep overall localStorage)
document.getElementById('closeShiftBtn').onclick = ()=>{
  // clear trips_history for next shift only (keeps long-term stats if desired)
  localStorage.setItem('trips_history', JSON.stringify([]));
  document.getElementById('shiftSummary').classList.add('hidden');
  // обновляем страницу как вы просили
  location.reload();
};

/* EXIT button (leave job) */
document.getElementById('exitVisible').onclick = ()=> location.href = "../business.html";

/* RENT TIMER */
function updateRentTimer(){
  // show nearest/active rent for activeModel first, otherwise any active rent
  let displayText = "";
  // if activeModel present and has expiry
  if(activeModel && activeModel.expires && activeModel.expires > Date.now()){
    let left = activeModel.expires - Date.now();
    let m = Math.floor(left / 60000);
    let s = Math.floor((left % 60000) / 1000);
    displayText = `Аренда (ваш транспорт): ${m}:${s<10?"0":""}${s}`;
  } else {
    // find any active rented model and show closest expiry
    let soon = null;
    Object.keys(rentedModels).forEach(type=>{
      Object.keys(rentedModels[type]).forEach(idx=>{
        const ex = rentedModels[type][idx];
        if(ex > Date.now()){
          if(!soon || ex < soon.expires) soon = {type, idx, expires: ex};
        }
      });
    });
    if(soon){
      let left = soon.expires - Date.now();
      let m = Math.floor(left / 60000);
      let s = Math.floor((left % 60000) / 1000);
      displayText = `Аренда: ${m}:${s<10?"0":""}${s} (${soon.type} ${soon.idx})`;
    }
  }
  document.getElementById("rentTimer").textContent = displayText;
}
setInterval(updateRentTimer, 1000);
updateRentTimer();

// Fix: ensure Close button on model select returns to transport selection
if(document.getElementById('closeModelSelect')){
  document.getElementById('closeModelSelect').onclick = ()=>{
    document.getElementById('modelSelectModal').classList.add('hidden');
    const tm = document.getElementById('transportModal'); if(tm) tm.classList.remove('hidden');
  };
}


/* START: when page loads we show transport modal (always) */
document.addEventListener('DOMContentLoaded', ()=>{
  
// === Исправленный обработчик кнопки Выйти ===
const exitModalBtn = document.getElementById('exitJobBtn');
if(exitModalBtn){
  exitModalBtn.onclick = ()=>{ window.location.href = '../business.html'; };
}

  // always show transport modal on entry (as requested)
  document.getElementById('transportModal').classList.remove('hidden');
  drawTransport();
  updateUI();

  // restore activeModel visual if present
  if(activeModel && activeModel.type){
    // if rental expired — clear it
    const expires = activeModel.expires || (rentedModels[activeModel.type] && rentedModels[activeModel.type][activeModel.index]);
    if(!expires || expires <= Date.now()){
      activeModel = null;
      localStorage.removeItem('activeModel');
    } else {
      // set transport to active model type but still keep modal shown (you said initial modal always visible)
      transport = activeModel.type;
      setTransportStaticImage(activeModel.type, activeModel.index);
    }
  }
});

// === Автоматическое завершение смены при выходе ===
function autoFinishAndExit(){
  try {
    if (typeof finishShift === 'function') {
      finishShift();
    }
  } catch(e){ console.error('autoFinish error', e); }
  setTimeout(()=>{ window.location.href = '../business.html'; }, 400);
}
document.querySelectorAll('#exitVisible,#exitJobBtn').forEach(btn => {
  if(btn){ btn.onclick = ()=> autoFinishAndExit(); }
});

</script>
</body>
</html>

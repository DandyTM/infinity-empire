<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>I.Deliv — Курьер</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #efefef;
      --card: #ffffffee;
      --muted: #666;
      --accent: #FFD200;
      --text: #111;
      --shadow: 0 10px 26px rgba(0, 0, 0, .18);
      --shell-bg: radial-gradient(circle at top, rgba(255,255,255,0.9) 0, transparent 55%),
        linear-gradient(180deg, #f4f4f8, #d9d9e2);
    }
    [data-theme="dark"] {
      --bg: #050816;
      --card: rgba(12, 12, 18, 0.96);
      --muted: #bdbdbd;
      --accent: #FFD200;
      --text: #f7f7f7;
      --shadow: 0 12px 36px rgba(0, 0, 0, .6);
      --shell-bg: radial-gradient(circle at top, rgba(255, 255, 255, 0.07) 0, transparent 55%),
        linear-gradient(180deg, #14141c, #050509);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
      -webkit-tap-highlight-color: transparent;
    }

    .app-shell {
      position: relative;
      width: 100%;
      max-width: 480px;
      height: 100vh;
      background: var(--shell-bg);
      overflow: hidden;
      box-sizing: border-box;
      padding-top: calc(env(safe-area-inset-top, 0px) + 8px);
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 70px);
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 600px) {
      .app-shell {
        margin: 12px auto;
        border-radius: 26px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
      }
    }

    /* ---- TOP BAR ---- */
    .top-bar {
      padding: 8px 16px 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      z-index: 10;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 32px;
      display: block;
    }

    .top-title {
      font-size: 18px;
      font-weight: 700;
    }

    .top-subtitle {
      font-size: 12px;
      opacity: 0.8;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* rating box */
    #ratingBox {
      background: var(--card);
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .18);
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: var(--text);
      min-width: 120px;
    }

    #orderCountView {
      font-weight: 600;
      color: var(--muted);
      font-size: 12px;
    }

    .header-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .header-btn {
      border-radius: 10px;
      padding: 7px 10px;
      border: 1px solid rgba(0, 0, 0, .12);
      background: var(--card);
      color: var(--text);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .18);
      white-space: nowrap;
    }

    .header-btn.primary {
      background: var(--accent);
      color: #111;
      border-color: transparent;
    }

    .header-btn-danger {
      background: #ff6b6b;
      color: #111;
      border-color: transparent;
    }

    .header-btn.full-width {
      width: 100%;
      margin-top: 8px;
      text-align: center;
    }

    .header-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 10px rgba(0, 0, 0, .3);
    }

    /* theme switch */
    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: 14px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.22);
      box-shadow: 0 4px 12px rgba(0, 0, 0, .35);
      font-size: 11px;
      font-weight: 700;
    }

    .switch {
      width: 46px;
      height: 26px;
      border-radius: 16px;
      display: inline-block;
      position: relative;
      background: #222;
      border: 2px solid rgba(0, 0, 0, .2);
    }

    .switch .knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #fff;
      transition: all .18s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .25);
    }

    [data-theme="dark"] .switch {
      background: var(--accent);
      border-color: rgba(0, 0, 0, .25);
    }

    [data-theme="dark"] .switch .knob {
      left: 22px;
      background: #111;
    }

    /* ---- MAIN CONTENT ---- */
    .screen-content {
      flex: 1;
      padding: 4px 16px 16px;
      overflow-y: auto;
    }

    /* level card (баланс, уровень, XP) */
    #levelBlock {
      width: 100%;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    #levelView {
      font-size: 16px;
      font-weight: 700;
    }

    #balanceInLevel {
      margin-top: 4px;
      font-size: 14px;
      font-weight: 600;
    }

    #rentTimer {
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    #xpBarWrapper {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, .18);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }

    #xpBar {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width .25s;
      border-radius: 999px;
    }

    #xpText {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      text-align: right;
    }

    /* goal box */
    #goalBox {
      width: 100%;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, .35);
      margin-bottom: 12px;
      cursor: pointer;
      transition: box-shadow .22s ease, transform .22s ease;
    }

    #goalBox.expanded {
      box-shadow: 0 14px 32px rgba(0, 0, 0, .5);
      transform: translateY(-2px);
    }

    #goalExpanded {
      margin-top: 8px;
    }

    #goalSmallText {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.35;
    }

    #goalSmallText b {
      font-size: 15px;
      font-weight: 800;
    }

    #goalDescription {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      opacity: 0.9;
      line-height: 1.35;
      margin-bottom: 8px;
    }

    #goalChoices > div {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, .2);
      background: rgba(0, 0, 0, 0.12);
      font-size: 13px;
      font-weight: 600;
    }

    #goalChoices > div:active {
      transform: translateY(1px);
    }

    /* orders */
    #orderList {
      width: 100%;
      margin-top: 4px;
    }

    .order-card {
      width: 100%;
      background: var(--card);
      border-radius: 16px;
      padding: 14px 14px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform .18s, box-shadow .18s;
    }

    .order-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 40px rgba(0, 0, 0, .25);
    }

    .order-card .meta {
      opacity: .85;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
    }

    .take-btn {
      background: var(--accent);
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .22);
      white-space: nowrap;
    }

    .take-btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 10px rgba(0, 0, 0, .3);
    }

    /* active order at bottom (fixed over content, над нижним меню) */
    #activeOrderBox {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 74px);
      width: 100%;
      max-width: 480px;
      margin: 0;
      background: var(--card);
      padding: 12px 14px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .55);
      display: none;
      z-index: 900;
    }

    #activeOrderBox .title {
      font-weight: 800;
      margin-bottom: 6px;
    }

    #activeRow {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
    }

    #transportStatic {
      width: 44px;
      height: 44px;
      object-fit: contain;
      border-radius: 10px;
    }

    #roadWrapper {
      position: relative;
      flex: 1;
      height: 26px;
      background: rgba(0, 0, 0, .12);
      border-radius: 999px;
      overflow: hidden;
    }

    #roadProgress {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width .12s linear;
      border-radius: 999px;
    }

    #currentKmText {
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
    }

    #currentPayText {
      margin-top: 4px;
      font-weight: 800;
      font-size: 14px;
    }

    /* modals */
    .modal-back {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(4px);
    }

    .modal {
      width: 92%;
      max-width: 520px;
      border-radius: 18px;
      background: var(--card);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
      max-height: 82vh;
      overflow-y: auto;
    }

    .hidden {
      display: none !important;
    }

    .summary-row {
      padding: 6px 0;
      border-bottom: 1px solid rgba(0, 0, 0, .08);
      font-weight: 600;
      color: var(--muted);
      font-size: 13px;
    }

    /* transport list */
    .transport-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      background: var(--card);
      cursor: pointer;
      gap: 12px;
      margin-bottom: 8px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, .18);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
    }

    .transport-card:hover {
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 14px 32px rgba(0, 0, 0, .25);
    }

    .transport-card img {
      width: 44px;
      height: 44px;
      object-fit: contain;
      transition: transform .18s ease;
    }

    .transport-card:hover img {
      transform: scale(1.06);
    }

    .transport-name {
      font-weight: 800;
      font-size: 15px;
    }

    .transport-locked {
      color: #ff6f6f;
      font-size: 13px;
      margin-top: 4px;
      font-weight: 700;
    }

    .transport-card.selected {
      background: var(--accent);
      color: #111;
      box-shadow: 0 14px 44px rgba(0, 0, 0, .25);
    }

    .selected-badge {
      font-weight: 800;
      font-size: 12px;
    }

    /* profile */
    .profRow {
      padding: 4px 0;
      font-size: 13px;
    }

    .scroll-box {
      max-height: 160px;
      overflow-y: auto;
      font-size: 12px;
      margin-top: 4px;
    }

    .small {
      color: var(--muted);
      font-size: 12px;
    }

    .money-fly {
      position: fixed;
      font-weight: 800;
      font-size: 20px;
      color: var(--accent);
      pointer-events: none;
      z-index: 5000;
      animation: flyUp 1s ease forwards;
    }

    @keyframes flyUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      80% { transform: translateY(-65px) scale(1.35); opacity: 1; }
      100% { transform: translateY(-95px) scale(1); opacity: 0; }
    }

    /* ---- bottom nav ---- */
    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: env(safe-area-inset-bottom, 0px);
      width: 100%;
      max-width: 480px;
      height: 70px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(18px);
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid rgba(255, 255, 255, 0.18);
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
      color: #dfe9ff;
      text-decoration: none;
      gap: 2px;
      min-width: 50px;
    }

    .nav-item img {
      width: 24px;
      height: 24px;
      margin-bottom: 2px;
    }

    .nav-item span {
      opacity: 0.9;
    }

    .nav-item.active span {
      color: var(--accent);
      font-weight: 600;
      opacity: 1;
    }

    .nav-item.active img {
      transform: translateY(-1px);
    }
  </style>
</head>
<body>

<div class="app-shell">

  <!-- Верхняя панель -->
  <header class="top-bar">
    <div class="top-row">
      <div class="top-left">
        <img class="logo" src="./icons/infinity_go.png" alt="INFINITY GO">
        <div>
          <div class="top-title">I.Deliv — Курьер</div>
          <div class="top-subtitle">Доставляй заказы и прокачивай уровень</div>
        </div>
      </div>
      <div class="top-right">
        <div class="theme-toggle" id="themeToggle" title="Тема">
          <div style="font-size:11px;font-weight:700;">Тема</div>
          <div class="switch" id="themeSwitch"><div class="knob"></div></div>
        </div>
      </div>
    </div>

    <div class="top-row">
      <div id="ratingBox">
        <div id="ratingView">⭐ 0.00 (0)</div>
        <div id="orderCountView">Доставок: 0</div>
      </div>

      <div class="header-actions">
        <button id="openProfileBtn" class="header-btn">Профиль</button>
        <button id="endShiftVisible" class="header-btn">Смена</button>
        <button id="exitVisible" class="header-btn header-btn-danger">Выйти</button>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main class="screen-content">
    <section id="levelBlock">
      <div id="levelView">Новичок</div>
      <div id="balanceInLevel">Баланс: 0 ₽</div>
      <div id="rentTimer"></div>

      <div id="xpBarWrapper">
        <div id="xpBar"></div>
      </div>
      <div id="xpText">0 / 120 XP</div>
    </section>

    <section id="goalBox" class="collapsed">
      <div id="goalSmallText">Текущая цель:<br><b>отсутствует</b></div>

      <div id="goalExpanded" class="hidden">
        <div id="goalDescription"></div>
        <div id="goalChoices" class="hidden"></div>
      </div>
    </section>

    <div id="orderList"></div>
  </main>

  <!-- Активный заказ -->
  <div id="activeOrderBox">
    <div class="title">Активный заказ</div>
    <div id="currentRoute" style="font-weight:700;margin-bottom:8px;"></div>

    <div id="activeRow">
      <img id="transportStatic" src="./icons/case.png" alt="transport">
      <div id="roadWrapper">
        <div id="roadProgress"></div>
      </div>
    </div>

    <div id="currentKmText"></div>
    <div id="currentPayText"></div>
    <div id="nextOrderBox" class="hidden" style="margin-top:10px;"></div>
  </div>

  <!-- Нижняя навигация -->
  <nav class="bottom-nav">
    <a href="../fun.html" class="nav-item">
      <img src="../assets/fun.png" alt="">
      <span>Развлечения</span>
    </a>
    <a href="../business.html" class="nav-item">
      <img src="../assets/business.png" alt="">
      <span>Бизнесы</span>
    </a>
    <a href="../index.html" class="nav-item">
      <img src="../assets/earn.png" alt="">
      <span>Заработок</span>
    </a>
    <a href="../profile.html" class="nav-item">
      <img src="../assets/profile.png" alt="">
      <span>Профиль</span>
    </a>
    <a href="../settings.html" class="nav-item">
      <img src="../assets/settings.png" alt="">
      <span>Настройки</span>
    </a>
  </nav>

</div>

<!-- Модалки и т.п. остаются на всём экране -->
<div id="transportModal" class="modal-back">
  <div class="modal">
    <h2 style="margin-bottom:12px;">Выберите способ передвижения</h2>
    <div id="transportList"></div>
    <button id="exitJobBtn" class="header-btn header-btn-danger full-width">Выйти</button>
    <button id="transportConfirm" class="header-btn primary full-width">Выйти на линию</button>
  </div>
</div>

<div id="modelSelectModal" class="modal-back hidden">
  <div class="modal">
    <h2 id="modelSelectTitle">Выбор модели</h2>
    <div id="modelList" style="margin-top:12px;display:flex;flex-direction:column;gap:12px;"></div>
    <button id="closeModelSelect" class="header-btn primary full-width">Закрыть</button>
  </div>
</div>

<div id="shiftSummary" class="modal-back hidden">
  <div class="modal" id="shiftSummaryContent">
    <h2>Смена завершена</h2>
    <div id="summaryList"></div>
    <h3 style="margin-top:12px;">Итого на баланс: <span id="sumTotal">0</span> ₽</h3>
    <button class="header-btn primary full-width" id="closeShiftBtn">Ок</button>
  </div>
</div>

<div id="profileModal" class="modal-back hidden">
  <div class="modal" id="profileContent">
    <h2>Профиль курьера</h2>
    <div class="profRow"><b>Рейтинг:</b> <span id="profRating">⭐ 0.00 (0)</span></div>
    <div class="profRow"><b>Выполнено доставок:</b> <span id="profOrders">0</span></div>
    <div class="profRow"><b>Уровень:</b> <span id="profLvl">1</span></div>
    <div class="profRow"><b>Опыт:</b> <span id="profXP">0</span></div>
    <div class="profRow"><b>Баланс:</b> <span id="profMoney">0</span> ₽</div>
    <div class="profRow"><b>Пробег:</b> <span id="profKm">0</span> км</div>

    <button id="openTransportFromProfile" class="header-btn full-width" style="margin-top:8px;">Выбрать транспорт</button>

    <h3 style="margin-top:12px;">Последние заказы доставки</h3>
    <div id="profHistory" class="scroll-box"></div>

    <h3 style="margin-top:12px;">Отзывы клиентов</h3>
    <div id="profReviews" class="scroll-box"></div>

    <button id="closeProfile" class="header-btn primary full-width" style="margin-top:10px;">Закрыть</button>
  </div>
</div>

<audio id="orderSound" src="yandex.mp3"></audio>

<script>
// helpers compatible with main game: read/write amounts in RUB under key+'_rub'
function readRub(k){ return parseFloat(localStorage.getItem(k+'_rub')) || 0; }
function writeRub(k, v){ localStorage.setItem(k+'_rub', v); }

let balance = readRub('balance') || 0;
let ratingScore = +localStorage.getItem('courier_ratingScore') || 0;
let ratingCount = +localStorage.getItem('courier_ratingCount') || 0;
let completed = +localStorage.getItem('courier_completed') || 0;
let level = +localStorage.getItem('courier_level') || 1;
let xp = +localStorage.getItem('courier_xp') || 0;
let activeGoal = JSON.parse(localStorage.getItem('activeGoal') || 'null');

const titles = ["Новичок","Профи","Эксперт","Топ-курьер"];
const xpNeedArr = [210,1470,6000,999999];
function xpNeed(){ return xpNeedArr[Math.min(level-1, xpNeedArr.length-1)]; }

/* speeds */
const speed = { walk:3, bike:1.8, moto:1.8, car:0.8 };

/* transports */
const transports = [
  {type:"walk", icon:"case.png", name:"Пешком", req:1},
  {type:"bike", icon:"yandexbike.png", name:"Электровело", req:2},
  {type:"moto", icon:"scooter.png", name:"Мото", req:2},
  {type:"car", icon:"auto.png", name:"Авто", req:2}
];

/* МОДЕЛИ ТРАНСПОРТА (только аренда) */
const transportModels = {
  bike: [
    {name:"Yandex E-Bike", rent:700, mul:1.10, icon:"bike_yandex.png"},
    {name:"Xiaomi Himo C26", rent:900, mul:1.13, icon:"bike_himo.png"},
    {name:"Kugoo V3 Pro", rent:1200, mul:1.16, icon:"bike_kugoo.png"}
  ],
  moto: [
    {name:"Honda Dio 50cc", rent:1500, mul:1.20, icon:"moto_dio.png"},
    {name:"Yamaha Jog 3KJ", rent:1800, mul:1.25, icon:"moto_jog.png"},
    {name:"Honda Super Cub", rent:2300, mul:1.30, icon:"moto_cub.png"}
  ],
  car: [
    {name:"Daewoo Matiz 0.8", rent:2500, mul:1.35, icon:"car_matiz.png"},
    {name:"Lada Granta Sedan", rent:3800, mul:1.45, icon:"car_granta.png"},
    {name:"Kia Rio (III)", rent:7500, mul:1.60, icon:"car_rio.png"}
  ]
};

let rentedModels = JSON.parse(localStorage.getItem('rentedModels') || '{}');
let activeModel = JSON.parse(localStorage.getItem('activeModel') || 'null');

let transport = null;
let selectedTransport = null;
let orderActive = false;
let current = null;

function saveAll(){
  writeRub('balance', balance);
  localStorage.setItem('courier_ratingScore', ratingScore);
  localStorage.setItem('courier_ratingCount', ratingCount);
  localStorage.setItem('courier_completed', completed);
  localStorage.setItem('courier_level', level);
  localStorage.setItem('courier_xp', xp);
  localStorage.setItem('rentedModels', JSON.stringify(rentedModels));
  localStorage.setItem('activeModel', JSON.stringify(activeModel));
}

function updateGoalUI(){
  const small = document.getElementById("goalSmallText");
  const desc = document.getElementById("goalDescription");

  if(!activeGoal){
    small.innerHTML = "Текущая цель:<br><b>отсутствует</b>";
    if (desc) desc.textContent = "";
    return;
  }

  if(activeGoal.type === "orders"){
    small.innerHTML = `Текущая цель:<br>заказов ${activeGoal.progress}/${activeGoal.need} (+${activeGoal.reward} ₽)`;
    desc.innerHTML = `Выполните <b>${activeGoal.need}</b> заказов, чтобы получить <b>${activeGoal.reward} ₽</b>.`;
  } else {
    small.innerHTML = `Текущая цель:<br>${Math.round(activeGoal.progress)}/${activeGoal.need} км (+${activeGoal.reward} ₽)`;
    desc.innerHTML = `Преодолейте <b>${activeGoal.need} км</b>, чтобы получить <b>${activeGoal.reward} ₽</b>.`;
  }
}

function updateRentTimer(){
  let displayText = "";
  if(activeModel && activeModel.expires && activeModel.expires > Date.now()){
    let left = activeModel.expires - Date.now();
    let m = Math.floor(left / 60000);
    let s = Math.floor((left % 60000) / 1000);
    displayText = `Аренда (ваш транспорт): ${m}:${s<10?"0":""}${s}`;
  } else {
    let soon = null;
    Object.keys(rentedModels).forEach(type=>{
      Object.keys(rentedModels[type]).forEach(idx=>{
        const ex = rentedModels[type][idx];
        if(ex > Date.now()){
          if(!soon || ex < soon.expires) soon = {type, idx, expires: ex};
        }
      });
    });
    if(soon){
      let left = soon.expires - Date.now();
      let m = Math.floor(left / 60000);
      let s = Math.floor((left % 60000) / 1000);
      displayText = `Аренда: ${m}:${s<10?"0":""}${s} (${soon.type} ${soon.idx})`;
    }
  }
  const el = document.getElementById("rentTimer");
  if (el) el.textContent = displayText;
}

function updateUI(){
  const avg = ratingCount ? (ratingScore / ratingCount).toFixed(2) : '0.00';
  document.getElementById('ratingView').textContent = `⭐ ${avg} (${ratingCount})`;
  document.getElementById('orderCountView').textContent = 'Доставок: ' + (localStorage.getItem('completed_orders')||completed);
  document.getElementById('levelView').textContent = titles[Math.min(level-1, titles.length-1)];
  document.getElementById('xpText').textContent = `${xp} / ${xpNeed()} ⚡`;
  document.getElementById('balanceInLevel').textContent = "Баланс: " + balance + " ₽";

  const xpBar = document.getElementById('xpBar');
  if (xpBar) {
    const pct = Math.max(0, Math.min(100, xp / xpNeed() * 100));
    xpBar.style.width = pct + '%';
  }

  updateRentTimer();
  saveAll();
  updateGoalUI();
}
updateUI();
setInterval(updateRentTimer, 1000);

document.getElementById("goalBox").onclick = ()=>{
  const box = document.getElementById("goalBox");
  const expanded = document.getElementById("goalExpanded");
  const choices = document.getElementById("goalChoices");

  if(activeGoal){
    choices.classList.add("hidden");
    expanded.classList.toggle("hidden");
    box.classList.toggle("expanded");
    return;
  }

  expanded.classList.remove("hidden");
  box.classList.add("expanded");
  choices.classList.remove("hidden");
  choices.innerHTML = "";

  randomGoals().forEach(g=>{
    const div = document.createElement("div");
    div.innerHTML = (g.type==="orders")
      ? `${g.need} заказов (+${g.reward} ₽)`
      : `Преодолей ${g.need} км (+${g.reward} ₽)`;

    div.onclick = ()=>{
      activeGoal = g;
      localStorage.setItem('activeGoal', JSON.stringify(activeGoal));
      expanded.classList.add("hidden");
      box.classList.remove("expanded");
      updateGoalUI();
    };

    choices.appendChild(div);
  });
};

function playSound(){
  const a = document.getElementById('orderSound');
  if(a){
    try{
      a.currentTime = 0;
      a.play().catch(()=>{});
    }catch(e){}
  }
}

/* THEME handling */
(function(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved === 'dark' ? 'dark' : 'light');
  const knob = document.querySelector('.switch .knob');
  if(saved === 'dark') knob.style.left='22px';
  document.getElementById('themeToggle').onclick = () => {
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
    knob.style.left = (cur === 'dark') ? '22px' : '2px';
  };
})();

/* TRANSPORT DRAW */
function drawTransport(){
  const box = document.getElementById('transportList');
  box.innerHTML = '';
  transports.forEach(t=>{
    const locked = level < t.req;
    const card = document.createElement('div');
    card.className = 'transport-card';
    if(selectedTransport === t.type) card.classList.add('selected');

    const iconPath = `./icons/${t.icon}`;
    const leftHTML = `<div style="display:flex;align-items:center;gap:14px;">
      <img src="${iconPath}" alt="${t.name}">
      <div>
        <div class="transport-name">${t.name}</div>
        ${locked ? `<div class="transport-locked">Доступно с уровня ${t.req}</div>` : ""}
      </div>
    </div>`;

    const rightHTML = selectedTransport === t.type
      ? `<div class="selected-badge">Выбрано</div>`
      : `<div style="color:var(--muted);font-weight:700"></div>`;

    card.innerHTML = leftHTML + rightHTML;

    if(!locked){
      card.onclick = ()=> {
        selectedTransport = t.type;
        drawTransport();
      };
      card.style.opacity = '1';
      card.style.cursor = 'pointer';
    } else {
      card.style.opacity = '.45';
      card.style.cursor = 'not-allowed';
    }

    box.appendChild(card);
  });
}
drawTransport();

/* MODELS */
function drawModels(type){
  document.getElementById('modelSelectTitle').textContent = "Выбор модели — " + (type || '').toUpperCase();
  const box = document.getElementById('modelList');
  box.innerHTML = '';

  if(type === 'walk'){
    const div = document.createElement('div');
    div.className = 'transport-card';
    div.innerHTML = `<div style="flex:1;font-weight:700">Пешком — без модели</div>
      <div><button class="take-btn" onclick="useWalk()">Использовать</button></div>`;
    box.appendChild(div);
    return;
  }

  (transportModels[type] || []).forEach((m,i)=>{
    const rented = rentedModels[type] && rentedModels[type][i] && rentedModels[type][i] > Date.now();
    const isActive = activeModel && activeModel.type === type && activeModel.index === i;
    const div = document.createElement('div');
    div.className = 'transport-card';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:14px;">
        <img src="./icons/${m.icon}" style="width:48px;height:48px;" alt="${m.name}">
        <div>
          <div class="transport-name">${m.name}</div>
        </div>
      </div>
      <div>
        ${
          isActive ? `<div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;"><div class="selected-badge">Активно</div><button class="take-btn" onclick="useModel('${type}',${i})">Выбрать</button></div>` :
          rented ? `<button class="take-btn" onclick="useModel('${type}',${i})">Использовать (Аренда)</button>` :
          `<button class="take-btn" onclick="rentModel('${type}',${i})">Аренда ${m.rent} ₽</button>`
        }
      </div>
    `;
    box.appendChild(div);
  });
}

document.getElementById('transportConfirm').onclick = () => {
  if (!selectedTransport) {
    // аккуратный тост "Выберите транспорт"
    const d = document.createElement('div');
    d.textContent = 'Выберите транспорт';
    d.style.position = 'fixed';
    d.style.bottom = '120px';
    d.style.left = '50%';
    d.style.transform = 'translateX(-50%)';
    d.style.background = 'var(--card)';
    d.style.padding = '10px 14px';
    d.style.borderRadius = '12px';
    d.style.boxShadow = '0 8px 26px rgba(0,0,0,.18)';
    d.style.fontSize = '13px';
    d.style.fontWeight = '600';
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 1400);
    return;
  }

  // пешком — сразу на линию, без моделей
  if (selectedTransport === 'walk') {
    useWalk();
    return;
  }

  // остальное — выбираем модель транспорта
  transport = selectedTransport;
  drawModels(transport);
  document.getElementById('modelSelectModal').classList.remove('hidden');
};

/* rent a model (30 min) */
function rentModel(type, i) {
  const m = transportModels[type][i];
  if (!m) return;

  if (balance < m.rent) {
    const d = document.createElement('div');
    d.textContent = 'Недостаточно средств';
    d.style.position = 'fixed';
    d.style.bottom = '120px';
    d.style.left = '50%';
    d.style.transform = 'translateX(-50%)';
    d.style.background = 'var(--card)';
    d.style.padding = '10px 14px';
    d.style.borderRadius = '12px';
    d.style.boxShadow = '0 8px 26px rgba(0,0,0,.18)';
    d.style.fontSize = '13px';
    d.style.fontWeight = '600';
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 1400);
    return;
  }

  balance -= m.rent;
  rentedModels[type] = rentedModels[type] || {};
  rentedModels[type][i] = Date.now() + 30 * 60 * 1000; // 30 мин
  saveAll();
  drawModels(type);
  updateUI();
}

/* использование уже арендованной модели */
function useModel(type, i) {
  const expires = rentedModels[type] && rentedModels[type][i];
  if (!expires || expires <= Date.now()) {
    const d = document.createElement('div');
    d.textContent = 'Аренда истекла, нужно продлить';
    d.style.position = 'fixed';
    d.style.bottom = '120px';
    d.style.left = '50%';
    d.style.transform = 'translateX(-50%)';
    d.style.background = 'var(--card)';
    d.style.padding = '10px 14px';
    d.style.borderRadius = '12px';
    d.style.boxShadow = '0 8px 26px rgba(0,0,0,.18)';
    d.style.fontSize = '13px';
    d.style.fontWeight = '600';
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 1400);
    return;
  }

  activeModel = { type, index: i, expires };
  localStorage.setItem('activeModel', JSON.stringify(activeModel));
  transport = type;
  setTransportStaticImage(type, i);

  // закрываем выбор модели и стартовый модал транспорта
  document.getElementById('modelSelectModal').classList.add('hidden');
  document.getElementById('transportModal').classList.add('hidden');

  drawModels(type);
  updateUI();
  setTimeout(() => newOrder(), 160);
}

/* пешком — без моделей */
function useWalk() {
  transport = 'walk';
  activeModel = null;
  localStorage.removeItem('activeModel');
  setTransportStaticImage('walk');

  document.getElementById('modelSelectModal').classList.add('hidden');
  document.getElementById('transportModal').classList.add('hidden');

  updateUI();
  setTimeout(() => newOrder(), 160);
}

/* картинка транспорта в активном заказе */
function setTransportStaticImage(type, modelIndex) {
  const el = document.getElementById('transportStatic');
  if (!el) return;

  const baseMap = {
    walk: './icons/case.png',
    bike: './icons/yandexbike.png',
    moto: './icons/scooter.png',
    car: './icons/auto.png'
  };

  let src = baseMap[type] || baseMap.walk;

  if (typeof modelIndex === 'number') {
    const list = transportModels[type];
    if (list && list[modelIndex]) {
      src = './icons/' + list[modelIndex].icon;
    }
  } else if (activeModel && activeModel.type === type) {
    const list = transportModels[type];
    if (list && typeof activeModel.index === 'number' && list[activeModel.index]) {
      src = './icons/' + list[activeModel.index].icon;
    }
  }

  el.src = src;
}

/* возможные цели (квесты) */
function randomGoals() {
  return [
    { type: 'orders', need: 25 + Math.floor(Math.random() * 20), reward: 2000 + Math.floor(Math.random() * 3000), progress: 0 },
    { type: 'orders', need: 10 + Math.floor(Math.random() * 15), reward: 1000 + Math.floor(Math.random() * 2000), progress: 0 },
    { type: 'distance', need: 50 + Math.floor(Math.random() * 100), reward: 2500 + Math.floor(Math.random() * 3500), progress: 0 }
  ];
}

/* точки "откуда" и "куда" */
const froms = [
  'ПВЗ Ozon, Сущёвский Вал 5',
  'ПВЗ WB, Павелецкая пл. 2',
  'KFC, Тверская 9',
  'Аптека 36.6, Цветной б-р 13',
  'McDonalds, Курская пл. 1'
];

const tos = [
  'ул. Бауманская, 27',
  'ул. Арбат, 14/1',
  'ул. Сретенка, 22',
  'ул. Покровка, 45',
  'пр-т Мира, 68'
];

/* генерация заказа по текущему транспорту */
function genOrder() {
  const A = froms[Math.floor(Math.random() * froms.length)];
  const B = tos[Math.floor(Math.random() * tos.length)];

  // диапазоны по дистанции
  let distMin = 0.3, distMax = 3; // пешком
  if (transport === 'bike' || transport === 'moto') { distMin = 1; distMax = 7; }
  if (transport === 'moto') { distMin = 1.5; distMax = 9; }
  if (transport === 'car') { distMin = 2.5; distMax = 15; }

  const dist = +(distMin + Math.random() * (distMax - distMin)).toFixed(1);

  // коэффициент оплаты
  let coef = 1;
  if (transport === 'bike') coef = 1.2;
  if (transport === 'moto') coef = 1.2;
  if (transport === 'car') coef = 1.4;

  let pay = dist * 50 * coef;

  // если модель арендована и аренда ещё активна — в оригинале множитель влияет только на скорость,
  // оплату не трогаем, но проверяем, что аренда не истекла
  if (activeModel && activeModel.type && typeof activeModel.index !== 'undefined') {
    const tm = transportModels[activeModel.type][activeModel.index];
    if (!(tm && rentedModels[activeModel.type] && rentedModels[activeModel.type][activeModel.index] > Date.now())) {
      // аренда кончилась
      activeModel = null;
      localStorage.removeItem('activeModel');
    }
  }

  pay = Math.round(pay);
  const xpGain = 3;

  return { A, B, dist, pay, xpGain, time: Date.now() };
}

/* один заказ в списке */
function newOrder() {
  // если уже в доставке — игнор
  const activeBox = document.getElementById('activeOrderBox');
  if (orderActive || (activeBox && activeBox.style.display === 'block')) return;
  if (!transport) return; // без транспорта не работаем

  current = genOrder();
  const box = document.getElementById('orderList');
  if (!box) return;

  box.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'order-card';
  card.innerHTML = `
    <div style="flex:1;">
      <div style="font-size:18px;font-weight:800">${current.A}</div>
      <div style="font-size:18px;font-weight:800;margin-top:6px">→ ${current.B}</div>
      <div class="meta" style="margin-top:8px;">${current.dist} км • ${current.pay} ₽ • +${current.xpGain}⚡</div>
    </div>
    <div style="margin-left:14px;">
      <button class="take-btn" id="takeBtn">Взять</button>
    </div>
  `;
  box.appendChild(card);

  playSound();

  const btn = document.getElementById('takeBtn');
  if (btn) {
    btn.onclick = () => {
      if (orderActive || !current) return;
      orderActive = true;
      startDelivery();
    };
  }
}

/* анимация дороги */
let animHandle = null;

function startDelivery() {
  if (!current) return;

  if (animHandle) cancelAnimationFrame(animHandle);

  if (activeModel) {
    setTransportStaticImage(activeModel.type, activeModel.index);
  } else {
    setTransportStaticImage(transport);
  }

  const activeBox = document.getElementById('activeOrderBox');
  activeBox.style.display = 'block';

  document.getElementById('currentRoute').textContent = current.A + ' → ' + current.B;
  document.getElementById('currentPayText').textContent = current.pay + ' ₽';
  document.getElementById('currentKmText').textContent = `Прогресс: 0 / ${current.dist} км`;
  document.getElementById('roadProgress').style.width = '0%';

  const sp = speed[transport] || 3;
  const duration = Math.max(2200, Math.round(current.dist * sp * 1000));

  const start = performance.now();
  function frame(now) {
    const p = Math.min((now - start) / duration, 1);
    document.getElementById('roadProgress').style.width = (p * 100).toFixed(1) + '%';
    document.getElementById('currentKmText').textContent =
      `Прогресс: ${(current.dist * p).toFixed(1)} / ${current.dist} км`;

    if (p < 1) {
      animHandle = requestAnimationFrame(frame);
    } else {
      animHandle = null;
      finishDelivery();
    }
  }

  animHandle = requestAnimationFrame(frame);
}

/* +₽ анимация */
function showMoneyFly(amount) {
  const d = document.createElement('div');
  d.className = 'money-fly';
  d.textContent = `+${amount} ₽`;
  d.style.left = '50%';
  d.style.top = '55%';
  d.style.transform = 'translateX(-50%)';
  document.body.appendChild(d);
  setTimeout(() => d.remove(), 1000);
}

/* завершение заказа */
function finishDelivery() {
  const active = document.getElementById('activeOrderBox');
  active.style.opacity = '0';

  setTimeout(() => {
    active.style.display = 'none';
    active.style.opacity = '1';

    completed++;
    balance += current.pay;
    showMoneyFly(current.pay);

    // цель
    if (activeGoal) {
      if (activeGoal.type === 'orders') {
        activeGoal.progress++;
      } else if (activeGoal.type === 'distance') {
        activeGoal.progress += current.dist;
      }

      if (activeGoal.progress >= activeGoal.need) {
        balance += activeGoal.reward;
        showMoneyFly(activeGoal.reward);
        activeGoal = null;
        localStorage.removeItem('activeGoal');
      } else {
        localStorage.setItem('activeGoal', JSON.stringify(activeGoal));
      }
      updateGoalUI();
    }

    // пробег
    let totalKm = parseFloat(localStorage.getItem('total_km') || '0');
    totalKm += current.dist;
    localStorage.setItem('total_km', totalKm.toFixed(2));

    // XP и уровень
    xp += current.xpGain;
    while (xp >= xpNeed()) {
      xp -= xpNeed();
      level++;
    }

    // рейтинг
    const addStars = Math.random() < 0.85 ? 5 : 4;
    ratingScore += addStars;
    ratingCount++;

    localStorage.setItem(
      'completed_orders',
      (+localStorage.getItem('completed_orders') || 0) + 1
    );

    // история поездок для смены/профиля
    let trips = JSON.parse(localStorage.getItem('trips_history') || '[]');
    trips.push(current);
    localStorage.setItem('trips_history', JSON.stringify(trips));

    saveAll();
    updateUI();

    orderActive = false;
    current = null;

    setTimeout(() => newOrder(), 600);
  }, 240);
}

/* ПРОФИЛЬ */
document.getElementById('openProfileBtn').onclick = () => {
  const ratingAvg = ratingCount ? (ratingScore / ratingCount).toFixed(2) : '0.00';
  document.getElementById('profRating').textContent = `⭐ ${ratingAvg} (${ratingCount})`;
  document.getElementById('profOrders').textContent =
    '' + (localStorage.getItem('completed_orders') || completed);
  document.getElementById('profLvl').textContent = level;
  document.getElementById('profXP').textContent = xp;
  document.getElementById('profMoney').textContent = balance;
  document.getElementById('profKm').textContent =
    (parseFloat(localStorage.getItem('total_km') || '0')).toFixed(1);

  const historyBox = document.getElementById('profHistory');
  let trips = JSON.parse(localStorage.getItem('trips_history') || '[]');
  if (!trips.length) {
    historyBox.innerHTML = '<div class="small">Пока нет выполненных доставок</div>';
  } else {
    historyBox.innerHTML = trips
      .slice(-30)
      .reverse()
      .map(t => `${t.A} → ${t.B} • ${t.dist} км • ${t.pay} ₽`)
      .map(t => `<div>${t}</div>`)
      .join('');
  }

  const reviewsBox = document.getElementById('profReviews');
  let reviews = JSON.parse(localStorage.getItem('courier_reviews') || '[]');
  if (!reviews.length) {
    reviewsBox.innerHTML = '<div class="small">Отзывы появятся после первых заказов</div>';
  } else {
    reviewsBox.innerHTML = reviews
      .slice(-20)
      .reverse()
      .map(r => `<div>⭐${r.stars} — ${r.text}</div>`)
      .join('');
  }

  document.getElementById('profileModal').classList.remove('hidden');
};

document.getElementById('closeProfile').onclick = () => {
  document.getElementById('profileModal').classList.add('hidden');
};

document.getElementById('openTransportFromProfile').onclick = () => {
  document.getElementById('profileModal').classList.add('hidden');
  document.getElementById('transportModal').classList.remove('hidden');
};

/* СМЕНА — итог смены */
function openShiftSummary() {
  const box = document.getElementById('summaryList');
  let trips = JSON.parse(localStorage.getItem('trips_history') || '[]');
  box.innerHTML = '';
  let total = 0;

  if (!trips.length) {
    box.innerHTML = '<div class="small">За смену заказов не было</div>';
  } else {
    trips.forEach(t => {
      total += t.pay || 0;
      const row = document.createElement('div');
      row.className = 'summary-row';
      row.textContent = `${t.A} → ${t.B} • ${t.dist} км • ${t.pay} ₽`;
      box.appendChild(row);
    });
  }

  document.getElementById('sumTotal').textContent = total;
  document.getElementById('shiftSummary').classList.remove('hidden');
}

function finishShift() {
  openShiftSummary();
}

document.getElementById('endShiftVisible').onclick = () => {
  finishShift();
};

document.getElementById('closeShiftBtn').onclick = () => {
  // очищаем историю смены
  localStorage.setItem('trips_history', JSON.stringify([]));
  document.getElementById('shiftSummary').classList.add('hidden');
  // перезагрузка экрана смены
  window.location.reload();
};

/* выход со смены с автозавершением */
function autoFinishAndExit() {
  try {
    finishShift();
  } catch (e) {
    console.error('autoFinish error', e);
  }
  setTimeout(() => { window.location.href = '../business.html'; }, 400);
}

document.querySelectorAll('#exitVisible,#exitJobBtn').forEach(btn => {
  if (btn) {
    btn.onclick = () => autoFinishAndExit();
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>INFINITY GO ‚Äî –¢–∞–∫—Å–∏</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg:#efefef;
  --card:#fff;
  --muted:#666;
  --accent:#FFD200;
  --text:#111;
  --shadow: 0 10px 26px rgba(0,0,0,.18);
}
[data-theme="dark"]{
  --bg:#0f0f11;
  --card:#121214;
  --muted:#bdbdbd;
  --accent:#FFD200;
  --text:#f7f7f7;
  --shadow: 0 12px 36px rgba(0,0,0,.6);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  overflow-x:hidden;
}

/* HEADER */
.header{
  position:fixed; top:0; left:0; right:0;
  display:flex; align-items:center; justify-content:center;
  padding:12px 18px; background:var(--card);
  border-bottom:1px solid rgba(0,0,0,.06); z-index:1200;
  box-shadow: var(--shadow);
}
.header img.logo{height:46px; display:block;}
.header .left, .header .right{position:absolute; top:10px; display:flex; gap:10px; align-items:center;}
.header .left{left:14px;}
.header .right{right:14px;}

/* RATING BOX */
#ratingBox{
  background:var(--card);
  border-radius:10px;
  padding:8px 10px;
  font-size:14px;font-weight:700;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  display:flex; flex-direction:column; align-items:flex-start;
  gap:4px;
  color:var(--text);
}
#levelSection {
  background: var(--card);
  padding: 12px 18px;
  border-radius: 14px;
  box-shadow: var(--shadow);
}

/* THEME TOGGLE */
.theme-toggle{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px; border-radius:14px; cursor:pointer;
}
.switch{
  width:46px; height:26px; border-radius:16px; display:inline-block; position:relative;
  background:#222; border:2px solid rgba(0,0,0,.08);
}
.switch .knob{
  position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%;
  background:#fff; transition:all .18s ease;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
[data-theme="dark"] .switch{ background:var(--accent); border-color:rgba(0,0,0,.25); }
[data-theme="dark"] .switch .knob{ left:22px; background:#111; }

/* HEADER BUTTONS (always visible) */
.header-btn{
  background:var(--card); border:1px solid rgba(0,0,0,.08);
  padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  color:var(--text);
}

/* TASK PANEL */
#taskPanel{
  margin:86px auto 14px;
  width:90%; max-width:720px;
  background:var(--accent); color:#111;
  padding:12px 16px; border-radius:14px; font-weight:700; text-align:center;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}

/* ORDER LIST */
#orderList{
  padding:8px;
  display:flex; flex-direction:column; align-items:center; gap:14px;
  margin-bottom:200px;
  max-width:980px; margin-left:auto; margin-right:auto;
}

/* ORDER CARD */
.order-card{
  width:92%; max-width:720px; background:var(--card); border-radius:14px;
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center;
  cursor:pointer; box-shadow:var(--shadow); transition:transform .18s, box-shadow .18s;
}
.order-card:hover{ transform:translateY(-6px); box-shadow: 0 18px 50px rgba(0,0,0,.22); }
.order-card .meta{opacity:.85; color:var(--muted); font-weight:600;}
.take-btn{
  background:var(--accent); border:none; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
}

/* ACTIVE ORDER (bottom) */
#activeOrderBox{
  position:fixed; left:0; right:0; bottom:18px;
  margin:0 auto; width:94%; max-width:960px;
  background:var(--card); padding:14px; border-radius:14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.28); display:none; z-index:1100;
}
#activeOrderBox .title{font-weight:800; margin-bottom:6px;}
#roadWrapper{ position:relative; height:28px; background:rgba(0,0,0,.06); border-radius:999px; overflow:hidden;}
#roadProgress{ height:100%; background:var(--accent); width:0%; transition: width .15s linear; border-radius:999px;}
#carIcon{
  position:absolute;
  top:-9px; /* –ø–æ–¥–Ω—è–ª–∏ –≤—ã—à–µ */
  left:0;
  width:40px; /* —É–º–µ–Ω—å—à–∏–ª–∏ —Ä–∞–∑–º–µ—Ä */ 
  transform:scaleX(-1);
  transition:left .15s linear;
}


/* NEXT ORDER */
#nextOrderBox{ margin-top:10px; background: rgba(255, 208, 0, 0.9); padding:8px 12px; border-radius:10px; font-weight:700; }

/* MODALS */
.modal-back{
  position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:2000;
  backdrop-filter: blur(4px);
}
.modal{
  width:92%; max-width:520px; border-radius:18px; background:var(--card); padding:16px; box-shadow:var(--shadow);
}

/* CAR CARD in modal */
.car-card{
  display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; background:rgba(0,0,0,0.03);
  margin-bottom:12px; cursor:pointer;
}
.car-card img{ width:110px; height:70px; object-fit:cover; border-radius:10px; }

/* SHIFT SUMMARY */
.summary-row{ padding:8px 0; border-bottom:1px solid rgba(0,0,0,.06); font-weight:600; color:var(--muted); }

/* PROFILE */
#profileContent .profRow{ padding:8px 0; border-bottom:1px solid rgba(0,0,0,.06); }
#profileContent .small{ color:var(--muted); font-size:13px; }

/* small utilities */
.hidden{ display:none; }
.center{ text-align:center; }

/* responsive */
@media(max-width:640px){
  #taskPanel{ width:94% }
  .order-card{ width:95% }
  #activeOrderBox{ width:96% }
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url("moscow.png") center/cover no-repeat;
  filter: blur(8px) brightness(0.75);
  z-index: -1;
  pointer-events: none;
  transition: background 0.4s ease, filter 0.4s ease;
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
[data-theme="dark"] body::before {
  background: url("moscow_night.png") center/cover no-repeat;
  filter: blur(8px) brightness(0.45);
}
/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Äî —Ç–µ–∫—Å—Ç –¥–ª—è –±–ª–æ–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ */
[data-theme="dark"] #nextOrderBox {
  color: #000 !important;
}
[data-theme="dark"] #xpBarWrapper {
  background: rgba(255,255,255,.25);
}
#statusRow {
  width: 90%;
  max-width: 900px;
  margin: 86px auto 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}



#levelBlock {
  width: 270px;
  background: var(--card);
  padding: 10px 14px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,.12);
}

#levelView {
  font-weight: 700;
  margin-bottom: 6px;
}

#xpBarWrapper {
  width: 100%;
  height: 8px;
  background: rgba(0,0,0,.14);
  border-radius: 8px;
  overflow:hidden;
  margin-bottom: 4px;
}

#xpBar {
  height: 100%;
  background: var(--accent);
  width: 0%;
  transition: width .25s;
}

#xpText {
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  text-align: right;
}

[data-theme="dark"] #xpBarWrapper {
  background: rgba(255,255,255,.18);
}
#levelBlock {
  position: fixed;
  top: 78px; /* —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∏–∑–æ–º header */
  right: 18px;
  width: 250px;
  background: var(--card);
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 10px 14px;
  z-index: 1500;
}

</style>
</head>
<body>

<!-- rating + counters on top-left -->
<div class="header">
  <div class="left">
    <div id="ratingBox">
      <div id="ratingView">‚≠ê 0.00 (0)</div>
      <div id="orderCountView" style="font-weight:600;color:var(--muted)">–ó–∞–∫–∞–∑–æ–≤: 0</div>
    </div>
  </div>

  <img class="logo" src="../icons/infinity_go.png" alt="INFINITY GO">

  <div class="right">
    <button id="openProfileBtn" class="header-btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button id="endShiftVisible" class="header-btn">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</button>
    <button id="exitVisible" class="header-btn">–í—ã–π—Ç–∏</button>

    <div class="theme-toggle" id="themeToggle" title="–¢–µ–º–∞">
      <div style="font-size:13px; font-weight:700;">–¢–µ–º–∞</div>
      <div class="switch" id="themeSwitch"><div class="knob"></div></div>
    </div>
  </div>
</div>


<div id="taskPanel">
  üéØ –ó–∞–¥–∞–Ω–∏–µ: –í—ã–ø–æ–ª–Ω–∏—Ç—å <span id="taskGoal">8</span> –∑–∞–∫–∞–∑–æ–≤ 
  (<span id="taskDone">0</span> / <span id="taskGoal2">8</span>) 
  ‚Äî –Ω–∞–≥—Ä–∞–¥–∞: +<span id="taskReward">3000</span> ‚ÇΩ
</div>
<div id="levelBlock">
  <div id="levelView">–£—Ä–æ–≤–µ–Ω—å: 1</div>
  <div id="xpBarWrapper">
    <div id="xpBar"></div>
  </div>
  <div id="xpText">0 / 120 XP</div>
</div>





<!-- orders list -->
<div id="orderList"></div>

<!-- active order (bottom) -->
<div id="activeOrderBox">
  <div class="title">–ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑</div>
  <div id="currentRoute" style="font-weight:700;margin-bottom:8px;"></div>

  <div id="roadWrapper">
    <div id="roadProgress"></div>
    <img id="carIcon" src="../icons/taxi.png" alt="taxi">
  </div>

  <div id="currentKmText" style="margin-top:8px;color:var(--muted)"></div>
  <div id="currentPayText" style="margin-top:6px;font-weight:800;"></div>
  <div id="nextOrderBox" class="hidden" style="margin-top:10px;"></div>
</div>

<!-- CAR SELECT MODAL -->
<div id="carModal" class="modal-back hidden">
  <div class="modal">
    <h3>–í—ã–±–µ—Ä–∏ –∞–≤—Ç–æ –¥–ª—è —Å–º–µ–Ω—ã</h3>
    <div id="carList"></div>
    <button class="header-btn" id="rentBtn" style="margin-top:8px;background:var(--accent);">–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∞–≤—Ç–æ</button>
  </div>
</div>

<!-- RENT CAR MODAL -->
<div id="rentModal" class="modal-back hidden">
  <div class="modal">
    <h3>–í—ã–±–µ—Ä–∏ –º–∞—à–∏–Ω—É –¥–ª—è –∞—Ä–µ–Ω–¥—ã</h3>

    <div id="rentList" style="margin-top:10px;"></div>

    <div class="center" style="margin-top:12px;">
      <button class="header-btn" onclick="closeRentModal()" style="background:var(--accent);">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- PARK SELECT modal -->
<div id="parkModal" class="modal-back hidden">
  <div class="modal">
    <h3>–í—ã–±–µ—Ä–∏ —Ç–∞–∫—Å–æ–ø–∞—Ä–∫</h3>
    <div class="car-card" style="justify-content:space-between; cursor:pointer;" onclick="setPark(0.10)">INFINITY GO –°—Ç–∞–Ω–¥–∞—Ä—Ç ‚Äî –∫–æ–º–∏—Å—Å–∏—è 10%</div>
    <div class="car-card" style="justify-content:space-between; cursor:pointer;" onclick="setPark(0.20)">INFINITY GO –ë–∏–∑–Ω–µ—Å ‚Äî –∫–æ–º–∏—Å—Å–∏—è 20% (–±–æ–ª—å—à–µ –¥–æ—Ä–æ–≥–∏—Ö –∑–∞–∫–∞–∑–æ–≤)</div>
    <div class="car-card" style="justify-content:space-between; cursor:pointer;" onclick="setPark(0.00)">–ß—ë—Ä–Ω—ã–π –ø–∞—Ä–∫ ‚Äî –∫–æ–º–∏—Å—Å–∏—è 0% (—Ä–∏—Å–∫ –ø–ª–æ—Ö–∏—Ö –æ—Ç–∑—ã–≤–æ–≤)</div>
  </div>
</div>

<!-- SHIFT SUMMARY -->
<div id="shiftSummary" class="modal-back hidden">
  <div class="modal" id="shiftSummaryContent">
    <h2>–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
    <div id="summaryList"></div>
    <h3 style="margin-top:12px">–ò—Ç–æ–≥–æ –Ω–∞ –±–∞–ª–∞–Ω—Å (–ø–æ—Å–ª–µ –∫–æ–º–∏—Å—Å–∏–∏ –ø–∞—Ä–∫–∞): <span id="sumTotal">0</span> ‚ÇΩ</h3>
    <div class="center" style="margin-top:12px;"><button class="header-btn" onclick="closeShiftSummary()" style="background:var(--accent);">–û–∫</button></div>
  </div>
</div>

<!-- PROFILE modal -->
<div id="profileModal" class="modal-back hidden">
  <div class="modal" id="profileContent">
    <h2>–ü—Ä–æ—Ñ–∏–ª—å —Ç–∞–∫—Å–∏—Å—Ç–∞</h2>
    <div class="profRow"><b>–†–µ–π—Ç–∏–Ω–≥:</b> <span id="profRating">‚≠ê 0.00 (0)</span></div>
    <div class="profRow"><b>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:</b> <span id="profOrders">0</span></div>
    <div class="profRow"><b>–£—Ä–æ–≤–µ–Ω—å:</b> <span id="profLvl">1</span></div>
    <div class="profRow"><b>–û–ø—ã—Ç:</b> <span id="profXP">0</span></div>
    <div class="profRow"><b>–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:</b> <span id="profMoney">0</span> ‚ÇΩ</div>
    <div class="profRow"><b>–û–±—â–∏–π –ø—Ä–æ–±–µ–≥:</b> <span id="profKm">0</span> –∫–º</div>
    <h3 style="margin-top:12px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
    <div id="profHistory" style="max-height:200px; overflow-y:auto; margin-top:8px;"></div>
    <h3 style="margin-top:12px;">–û—Ç–∑—ã–≤—ã –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</h3>
    <div id="profReviews" style="max-height:160px; overflow-y:auto; margin-top:8px;"></div>

    <div style="margin-top:12px;" class="center">
      <button id="closeProfile" class="header-btn" style="background:var(--accent);">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* -------------------------
  Persisted data in localStorage:
  - ratingScore (sum of stars)
  - ratingCount (count of ratings)
  - completed_orders (int)
  - total_km (number)
  - total_earn (number)
  - trips_history (array)
  - reviews (array of {text,stars})
  - theme ('light'|'dark')
-------------------------*/

/* THEME */
(function(){
  const saved = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved === 'dark' ? 'dark' : 'light');
  const switchEl = document.getElementById('themeSwitch');
  if(saved === 'dark') document.querySelector('.switch .knob').style.left='22px';
  document.getElementById('themeToggle').onclick = () => {
    const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
    if(cur === 'dark') document.querySelector('.switch .knob').style.left='22px';
    else document.querySelector('.switch .knob').style.left='2px';
  };
})();

/* RATING and REVIEWS */
let ratingScore = +localStorage.getItem('ratingScore') || 0;
let ratingCount = +localStorage.getItem('ratingCount') || 0;
let reviews = JSON.parse(localStorage.getItem('reviews')||'[]');

function saveReviews(){ localStorage.setItem('reviews', JSON.stringify(reviews)); }
function updateRatingUI(){
  const avg = ratingCount>0 ? (ratingScore/ratingCount).toFixed(2) : '0.00';
  document.getElementById('ratingView').textContent = `‚≠ê ${avg} (${ratingCount})`;
  document.getElementById('orderCountView').textContent = '–ó–∞–∫–∞–∑–æ–≤: ' + (localStorage.getItem('completed_orders')||0);
}
updateRatingUI();

/* add rating and an optional text review */
function addRating(stars, text){
  // if stars not provided, roll random
  let s = stars || (Math.random()*100 < 78 ? 5 : Math.random()*100 < 92 ? 4 : Math.random()*100 < 97 ? 3 : Math.random()*100 < 99 ? 2 : 1);
  ratingScore += s; ratingCount++;
  localStorage.setItem('ratingScore', ratingScore);
  localStorage.setItem('ratingCount', ratingCount);
  if(text){
    reviews.push({stars: s, text: text, time: Date.now()});
    saveReviews();
  } else {
    // small chance to generate a short review comment
    if(Math.random() < 0.45){
      const sample = ["–û—Ç–ª–∏—á–Ω–æ!", "–°–ø–∞—Å–∏–±–æ, –≤—Å–µ –±—ã—Å—Ç—Ä–æ", "–í–µ–∂–ª–∏–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å", "–ù–µ–º–Ω–æ–≥–æ –¥–æ–ª–≥–æ", "–ù–µ –æ—á–µ–Ω—å –≤–µ–∂–ª–∏–≤–æ"];
      const t = sample[Math.floor(Math.random()*sample.length)];
      reviews.push({stars: s, text: t, time: Date.now()});
      saveReviews();
    }
  }
  updateRatingUI();
}
let level = +localStorage.getItem('driver_level') || 1;
let xp = +localStorage.getItem('driver_xp') || 0;

function saveLevel(){
  localStorage.setItem('driver_level', level);
  localStorage.setItem('driver_xp', xp);
}

function updateXPUI(){
  // —Å–∫–æ–ª—å–∫–æ XP –Ω—É–∂–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
  const need = level * 120;
  const pct = Math.min((xp / need) * 100, 100);

  document.getElementById('levelView').textContent = `–£—Ä–æ–≤–µ–Ω—å: ${level}`;
  document.getElementById('xpBar').style.width = pct + '%';
  document.getElementById('xpText').textContent = `${xp} / ${need} XP`;
}


function addXP(amount){
  xp += amount;

  // XP –¥–ª—è —É—Ä–æ–≤–Ω–µ–π: –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º—É–ª—É
  let need = level * 120; // —á–µ–º –≤—ã—à–µ —É—Ä–æ–≤–µ–Ω—å, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ

  while(xp >= need){
    xp -= need;
    level++;
    need = level * 120;

    showEvent(`üéâ –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å ${level} —É—Ä–æ–≤–µ–Ω—å`);

    saveLevel();
    updateProfileUI(); // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
  }

  saveLevel();
  updateXPUI();

}

/* -------------------------
  CAR / PARK / ORDERS logic
-------------------------*/
let garage = JSON.parse(localStorage.getItem('garage')||'[]');
let selectedCar = null;
let parkCommission = 0.10;

function fixImg(p){
  if(!p) return '../icons/car-placeholder.png';
  if(p.startsWith('../')) return p;
  return '../' + p;
}
function getNumericPrice(obj){
  let v = obj && (obj.priceRub ?? obj.price ?? obj.priceRub ?? 0);
  return parseFloat(v) || 0;
}
function getClassByPriceNumeric(price){
  // thresholds: < 2_000_000 –≠–∫–æ–Ω–æ–º, <4_000_000 –ö–æ–º—Ñ–æ—Ä—Ç, <8_000_000 –ë–∏–∑–Ω–µ—Å, –∏–Ω–∞—á–µ –ü—Ä–µ–º–∏—É–º
  price = Number(price) || 0;
  if(price < 2000000) return '–≠–∫–æ–Ω–æ–º';
  if(price < 4000000) return '–ö–æ–º—Ñ–æ—Ä—Ç';
  if(price < 8000000) return '–ë–∏–∑–Ω–µ—Å';
  return '–ü—Ä–µ–º–∏—É–º';
}
const rentCars = [
  // –≠–∫–æ–Ω–æ–º
  { brand: "Hyundai", model: "Solaris", cls:"–≠–∫–æ–Ω–æ–º", priceRub:700000, img:"solaris.png", rentCost: 700 },
  { brand: "Kia", model: "Rio", cls:"–≠–∫–æ–Ω–æ–º", priceRub:750000, img:"kiario.png", rentCost: 750 },

  // –ö–æ–º—Ñ–æ—Ä—Ç
  { brand: "VW", model: "Polo", cls:"–ö–æ–º—Ñ–æ—Ä—Ç", priceRub:1200000, img:"polo.png", rentCost: 950 },
  { brand: "Skoda", model: "Octavia", cls:"–ö–æ–º—Ñ–æ—Ä—Ç", priceRub:1500000, img:"octavia.png", rentCost: 1100 },

  // –ë–∏–∑–Ω–µ—Å
  { brand: "Toyota", model: "Camry", cls:"–ë–∏–∑–Ω–µ—Å", priceRub:2500000, img:"camry.png", rentCost: 1700 },
  { brand: "BMW", model: "320i", cls:"–ë–∏–∑–Ω–µ—Å", priceRub:3400000, img:"320i.png", rentCost: 2100 }
];
function openRentModal(){
  document.getElementById('rentModal').classList.remove('hidden');
  const box = document.getElementById('rentList');
  box.innerHTML = '';

  rentCars.forEach((c, i) => {

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ –∫–ª–∞—Å—Å—É
    let requiredLevel = 1;
    if(c.cls === '–ö–æ–º—Ñ–æ—Ä—Ç') requiredLevel = 3;
    if(c.cls === '–ë–∏–∑–Ω–µ—Å') requiredLevel = 6;
    if(c.cls === '–ü—Ä–µ–º–∏—É–º') requiredLevel = 9;

    const locked = level < requiredLevel;

    box.innerHTML += `
      <div class="car-card" 
           style="opacity:${locked ? 0.45 : 1}; cursor:${locked ? 'not-allowed' : 'pointer'};" 
           ${locked ? '' : `onclick="rentSelect(${i})"`}>
        <img src="${c.img}" alt="car">
        <div>
          <div style="font-weight:800">${c.brand} ${c.model}</div>
          <div class="small">–ö–ª–∞—Å—Å: ${c.cls}</div>
          <div class="small">–ê—Ä–µ–Ω–¥–∞: ${c.rentCost} ‚ÇΩ / —Å–º–µ–Ω–∞</div>
          ${locked ? `<div style="color:#ff4444;font-weight:700;margin-top:6px;">–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å ${requiredLevel}</div>` : ''}
        </div>
      </div>
    `;
  });
}


function closeRentModal(){
  document.getElementById('rentModal').classList.add('hidden');
}

function rentSelect(i){
  selectedCar = { ...rentCars[i], rented: true, mileage: 0 };
  closeRentModal();
  document.getElementById('carModal').classList.add('hidden');
  openParkModal();
}

/* CAR SELECT UI */
function openCarModal(){
  document.getElementById('carModal').classList.remove('hidden');
  const box = document.getElementById('carList');
  box.innerHTML = '';

  if(garage.length === 0){
    box.innerHTML = '<div style="padding:14px;color:var(--muted)">–ì–∞—Ä–∞–∂ –ø—É—Å—Ç ‚Äî –º–æ–∂–Ω–æ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∞–≤—Ç–æ</div>';
    return;
  }

  garage.forEach((c,i)=>{

    const price = getNumericPrice(c);
    const cls = getClassByPriceNumeric(price);

    // –¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞
    let requiredLevel = 1;
    if(cls === '–ö–æ–º—Ñ–æ—Ä—Ç') requiredLevel = 3;
    if(cls === '–ë–∏–∑–Ω–µ—Å') requiredLevel = 6;
    if(cls === '–ü—Ä–µ–º–∏—É–º') requiredLevel = 9;

    const locked = level < requiredLevel;

    box.innerHTML += `
      <div class="car-card" 
           style="opacity:${locked ? 0.45 : 1}; cursor:${locked ? 'not-allowed' : 'pointer'};" 
           ${locked ? '' : `onclick="selectCar(${i})"`}>
        <img src="${fixImg(c.img||c.image||c.photo)}" alt="car">
        <div>
          <div style="font-weight:800">${(c.brand??'') + (c.model ? ' ' + c.model : '')}</div>
          <div class="small">–ö–ª–∞—Å—Å: ${cls}</div>
          <div class="small">–ü—Ä–æ–±–µ–≥: ${Math.round(c.mileage||0)} –∫–º</div>
          ${locked ? `<div style="color:#ff4444;font-weight:700;margin-top:6px;">–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å ${requiredLevel}</div>` : ''}
        </div>
      </div>
    `;
  });
}
document.getElementById('rentBtn').onclick = () => {
  openRentModal();
};


function selectCar(i){
  selectedCar = garage[i];
  document.getElementById('carModal').classList.add('hidden');
  openParkModal();
}

/* PARK selection */
function openParkModal(){ document.getElementById('parkModal').classList.remove('hidden'); }
function setPark(c){
  parkCommission = c;
  const modal = document.getElementById('parkModal');
  modal.classList.add('hidden');
  modal.style.display = 'none';    // ‚Üê –í–û–¢ –≠–¢–û –ì–õ–ê–í–ù–û–ï
  startOrders();
}


/* Task panel */
let taskGoal = 0;
let taskDone = 0;
let taskReward = 0;

function generateNewTask(){
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤: –æ—Ç 5 –¥–æ 12
  taskGoal = Math.floor(Math.random()*8) + 5; // 5‚Äì12
  taskDone = 0;

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–≥—Ä–∞–¥—É: 2000‚Äì6000 —Å –Ω–µ–±–æ–ª—å—à–∏–º —Ä–∞–∑–±—Ä–æ—Å–æ–º
  taskReward = (Math.floor(Math.random()*5)+2) * 1000;

  updateTaskUI();
}

function updateTaskUI(){
  document.getElementById('taskGoal').textContent = taskGoal;
  document.getElementById('taskGoal2').textContent = taskGoal;
  document.getElementById('taskDone').textContent = taskDone;
}


/* Order generation */
const streets = ["–¢–≤–µ—Ä—Å–∫–∞—è","–ê—Ä–±–∞—Ç","–°—Ä–µ—Ç–µ–Ω–∫–∞","–ë–∞—É–º–∞–Ω—Å–∫–∞—è","–õ—É–±—è–Ω–∫–∞","–ü—Ä–æ—Å–ø–µ–∫—Ç –ú–∏—Ä–∞","–°–∞–¥–æ–≤–∞—è","–õ—É–±—è–Ω—Å–∫–∞—è"];
function addr(){ return streets[Math.floor(Math.random()*streets.length)] + ' ' + (10 + Math.floor(Math.random()*90)); }

function makeOrder(){
  const from = addr();
  const to = addr();
  const baseDist = +(Math.random()*6 + 2).toFixed(1);

  const priceNum = getNumericPrice(selectedCar);
  const cls = getClassByPriceNumeric(priceNum);

  // –±–∞–∑–æ–≤—ã–µ —à–∞–Ω—Å—ã
  let vipChance = 0.08;     // 8%
  let airportChance = 0.04; // 4%

  // —É—Å–∏–ª–∏–≤–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–ª–∞—Å—Å–∞ –∞–≤—Ç–æ
  if(cls === '–ö–æ–º—Ñ–æ—Ä—Ç'){
    vipChance += 0.04;      // +4%
  }
  if(cls === '–ë–∏–∑–Ω–µ—Å'){
    vipChance += 0.08;      // +8%
    airportChance += 0.04;  // +4%
  }
  if(cls === '–ü—Ä–µ–º–∏—É–º'){
    vipChance += 0.12;      // +12%
    airportChance += 0.12;  // +12%
  }

  function calcPay(dist){
    if(cls === '–≠–∫–æ–Ω–æ–º') return Math.round(90 + dist*35);
    if(cls === '–ö–æ–º—Ñ–æ—Ä—Ç') return Math.round(150 + dist*55);
    if(cls === '–ë–∏–∑–Ω–µ—Å') return Math.round(250 + dist*85);
    return Math.round(420 + dist*130); // –ü—Ä–µ–º–∏—É–º
  }


// VIP
if(Math.random() < vipChance){
  const dist = baseDist + Math.random()*4;
  return {
    A: from, B: to,
    dist: +dist.toFixed(1),
    pay: calcPay(dist) * 2,
    vip: true,
    cls
  };
}

// –ê–≠–†–û–ü–û–†–¢
if(Math.random() < airportChance){
  const dist = 15 + Math.random()*15; // 15‚Äì30 –∫–º
  return {
    A: "–ê—ç—Ä–æ–ø–æ—Ä—Ç", B: to,
    dist: +dist.toFixed(1),
    pay: calcPay(dist),
    airport: true,
    cls
  };
}


  // –æ–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑
  return { A: from, B: to, dist: baseDist, pay: calcPay(baseDist) };
}


/* Orders list handling */
let orderList = [];
function drawOrders(){
  const box = document.getElementById('orderList');
  box.innerHTML = '';

  orderList.forEach((o, i) => {

    // XP preview (—Ç–∞ –∂–µ —Ñ–æ—Ä–º—É–ª–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å!)
    let xpPreview = 10 + o.dist * 2;
    if(o.cls === '–ö–æ–º—Ñ–æ—Ä—Ç') xpPreview = 14 + o.dist * 3;
    if(o.cls === '–ë–∏–∑–Ω–µ—Å') xpPreview = 20 + o.dist * 3.5;
    if(o.cls === '–ü—Ä–µ–º–∏—É–º') xpPreview = 30 + o.dist * 4;
    if(o.airport) xpPreview += 25;
    if(o.vip) xpPreview *= 1.8;
    xpPreview = Math.round(xpPreview);

    let label = "";
    if(o.vip) label = `<span style="background:#ffdd00;padding:3px 7px;border-radius:6px;font-weight:800;color:#111;margin-right:8px;">VIP</span>`;
    if(o.airport) label = `<span style="background:#007bff;padding:3px 7px;border-radius:6px;font-weight:800;color:#fff;margin-right:8px;">‚úà –ê—ç—Ä–æ–ø–æ—Ä—Ç</span>`;

    const el = document.createElement('div');
    el.className = 'order-card';
    el.innerHTML = `
      <div>
        <div style="font-weight:800;">${label}${o.A} ‚Üí ${o.B}</div>
        <div class="meta">${o.dist} –∫–º ¬∑ ${o.pay} ‚ÇΩ ¬∑ +${xpPreview} XP ¬∑ ${o.cls || ''}</div>
      </div>
      <div>
        <button class="take-btn" onclick="takeOrder(${i})">–í–∑—è—Ç—å</button>
      </div>
    `;
    box.appendChild(el);
  });
}



function refreshOrders(){
  try{
    if(orderList.length < 4) orderList.push(makeOrder());
    playSound();
    drawOrders();
  }catch(e){ console.error('refreshOrders error', e); }
}

/* Order taking / queue logic (max 1 queue) */
let current = null;
let queue = null;
let animationHandle = null;
let completedTrips = JSON.parse(localStorage.getItem('trips_history')||'[]');
let shiftEarn = 0;

function takeOrder(i){
  const o = orderList.splice(i,1)[0];
  drawOrders();
  if(current){
    if(queue){ alert('–£–∂–µ –µ—Å—Ç—å –∑–∞–∫–∞–∑ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏.'); return; }
    queue = o; updateQueueUI(); return;
  }
  startTrip(o);
}

function updateQueueUI(){
  const nbox = document.getElementById('nextOrderBox');
  if(queue){
    nbox.classList.remove('hidden');
    nbox.textContent = '–°–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑: ' + queue.A + ' ‚Üí ' + queue.B;
  } else {
    nbox.classList.add('hidden');
  }
}

/* Random events: affect rating, tips, speed */
function randomEvent(){
  const r = Math.random()*100;
  if(r < 12) return 'traffic';
  if(r < 22) return 'rain';
  if(r < 36) return 'tips';
  if(r < 44) return 'angry';
  return 'none';
}

function showEvent(msg){
  const d = document.createElement('div');
  d.style.position='fixed';
  d.style.bottom='140px';
  d.style.left='50%';
  d.style.transform='translateX(-50%)';
  d.style.background='var(--card)';
  d.style.color='var(--text)';
  d.style.padding='10px 14px';
  d.style.borderRadius='12px';
  d.style.boxShadow='0 8px 26px rgba(0,0,0,.18)';
  d.style.fontWeight='700';
  d.style.zIndex='2002';
  d.textContent = msg;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),2200);
}

/* Trip logic (smooth animation using requestAnimationFrame) */
function startTrip(o){
  current = o;
  document.getElementById('activeOrderBox').style.display = 'block';
  document.getElementById('currentRoute').textContent = o.A + ' ‚Üí ' + o.B;
  document.getElementById('currentPayText').textContent = o.pay + ' ‚ÇΩ';
  updateQueueUI();

  const event = randomEvent();
  let speedFactor = 1;
  if(event === 'traffic'){ speedFactor = 0.6; showEvent('üöß –ü—Ä–æ–±–∫–∞ ‚Äî –µ–¥–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ'); }
  else if(event === 'rain'){ showEvent('‚òî –ò–¥—ë—Ç –¥–æ–∂–¥—å ‚Äî –ø–æ–≤–µ—à–µ–Ω–Ω—ã–π —à–∞–Ω—Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–∞'); }
  else if(event === 'tips'){ const tip = (50 + Math.floor(Math.random()*400)); o.pay += tip; showEvent('üí∏ –ß–∞–µ–≤—ã–µ: +' + tip + ' ‚ÇΩ'); }
  else if(event === 'angry'){ showEvent('üò† –ö–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ–≤–æ–ª–µ–Ω ‚Äî —à–∞–Ω—Å —Å–Ω–∏–∂–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏'); }

  // –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è: ~1.2 —Å–µ–∫ –∑–∞ –∫–º + –º–∏–Ω–∏–º—É–º
let baseTime = o.dist * 1200; // 1.2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –∫–∞–∂–¥—ã–π –∫–∏–ª–æ–º–µ—Ç—Ä
const durationMs = Math.max(3000, Math.round(baseTime / speedFactor));

  const start = performance.now();
  function frame(now){
    const progress = Math.min((now - start) / durationMs, 1);
    document.getElementById('roadProgress').style.width = (progress * 100) + '%';
    document.getElementById('carIcon').style.left = `calc(${progress * 100}% - 28px)`;
    document.getElementById('currentKmText').textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${ (o.dist * progress).toFixed(1) } / ${o.dist} –∫–º`;
    if(progress < 1) animationHandle = requestAnimationFrame(frame);
    else {
      cancelAnimationFrame(animationHandle);
      finishTrip(o, event);
    }
  }
  animationHandle = requestAnimationFrame(frame);
}

/* Finish trip */
function finishTrip(o, event){
  // –í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è
  taskDone++;
  updateTaskUI();

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è (–Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
  if(taskDone >= taskGoal){
    const bal = +localStorage.getItem('balance_rub') || 0;
    localStorage.setItem('balance_rub', bal + taskReward);
    showEvent(`üéâ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${taskReward} ‚ÇΩ`);
    generateNewTask();
  }

  // –û–±—â–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞
  const prevOrders = +localStorage.getItem('completed_orders') || 0;
  localStorage.setItem('completed_orders', prevOrders + 1);

  const prevKm = +localStorage.getItem('total_km') || 0;
  localStorage.setItem('total_km', (prevKm + o.dist));

  const prevEarn = +localStorage.getItem('total_earn') || 0;
  localStorage.setItem('total_earn', (prevEarn + o.pay));

  // –ü—Ä–æ–±–µ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è, –µ—Å–ª–∏ –Ω–µ –∞—Ä–µ–Ω–¥–∞
  if(selectedCar && !selectedCar.rented){
    selectedCar.mileage = (selectedCar.mileage || 0) + o.dist;
    localStorage.setItem('garage', JSON.stringify(garage));
  }

  // ‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –∑–∞ —Å–º–µ–Ω—É
  shiftEarn += o.pay;

  // ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
  completedTrips.push(o);
  localStorage.setItem('trips_history', JSON.stringify(completedTrips));

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ (–º—è–≥—á–µ)
  let stars;
  if(event === 'angry'){
    stars = Math.random() < 0.4 ? 3 : 4;
  } else if(event === 'rain'){
    stars = 5;
  } else {
    stars = Math.random() < 0.75 ? 5 : 4;
  }
  addRating(stars);

  // –°–∫—Ä—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑
  current = null;
  document.getElementById('activeOrderBox').style.display = 'none';
  document.getElementById('roadProgress').style.width = '0%';
  document.getElementById('carIcon').style.left = '0';

  // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–∫–∞–∑ –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –µ–≥–æ
  if(queue){
    const next = queue;
    queue = null;
    updateQueueUI();
    setTimeout(()=> startTrip(next), 300);
  }

  // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
  if(orderList.length < 4) refreshOrders();
  // XP –∑–∞ –∑–∞–∫–∞–∑ ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∞—Å—Å–∞ –∏ —Ç–∏–ø–∞
let baseXP = 10 + o.dist * 2; // –≠–∫–æ–Ω–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

if(o.cls === '–ö–æ–º—Ñ–æ—Ä—Ç') baseXP = 14 + o.dist * 3;
if(o.cls === '–ë–∏–∑–Ω–µ—Å') baseXP = 20 + o.dist * 3.5;
if(o.cls === '–ü—Ä–µ–º–∏—É–º') baseXP = 30 + o.dist * 4;

if(o.airport) baseXP += 25; // –ê—ç—Ä–æ–ø–æ—Ä—Ç –±–æ–Ω—É—Å
if(o.vip) baseXP *= 1.8; // VIP –º–Ω–æ–∂–∏—Ç–µ–ª—å

addXP(Math.round(baseXP));

}


/* Play sound when new order appears */
function playSound(){
  try{ new Audio('yandex.mp3').play().catch(()=>{}); }catch(e){}
}

/* END SHIFT: compute park commission, add to balance, show summary */
document.getElementById('endShiftVisible').onclick = endShift;
function endShift(){
  // compute payout after park commission
  const final = Math.round(shiftEarn * (1 - parkCommission));
  // add task reward if completed taskGoal
  if(taskDone >= taskGoal){
    localStorage.setItem('balance_rub', (+localStorage.getItem('balance_rub') || 0) + 3000);
  }
  // add final
  const prevBal = +localStorage.getItem('balance_rub') || 0;
  localStorage.setItem('balance_rub', prevBal + final);
  // display summary
  const box = document.getElementById('summaryList');
  box.innerHTML = '';
  completedTrips.forEach(t=>{
    box.innerHTML += `<div class="summary-row">${t.A} ‚Üí ${t.B} ‚Ä¢ ${t.dist} –∫–º ‚Ä¢ ${t.pay} ‚ÇΩ</div>`;
  });
  document.getElementById('sumTotal').textContent = final + (taskDone >= taskGoal ? 3000 : 0);
  // reset session shift earn and completedTrips for next shift
  shiftEarn = 0;
  completedTrips = [];localStorage.setItem('trips_history', JSON.stringify([]));

  document.getElementById('shiftSummary').classList.remove('hidden');
}

/* Close summary */
function closeShiftSummary(){ 
  document.getElementById('shiftSummary').classList.add('hidden');
  setTimeout(() => {
    location.reload();
  }, 200);
}


/* PROFILE modal open / close */
document.getElementById('openProfileBtn').onclick = function(){
  const ratingAvg = ratingCount>0 ? (ratingScore / ratingCount).toFixed(2) : '0.00';
  document.getElementById('profRating').textContent = `‚≠ê ${ratingAvg} (${ratingCount})`;
  document.getElementById('profOrders').textContent = localStorage.getItem('completed_orders') || 0;
  document.getElementById('profLvl').textContent = level;
  document.getElementById('profXP').textContent = xp;
  document.getElementById('profMoney').textContent = localStorage.getItem('total_earn') || 0;
  document.getElementById('profKm').textContent = Math.round(+localStorage.getItem('total_km') || 0);
  // history
  const hist = JSON.parse(localStorage.getItem('trips_history') || '[]');
  const hbox = document.getElementById('profHistory'); hbox.innerHTML = '';
  hist.slice(-12).reverse().forEach(t => {
    hbox.innerHTML += `<div class="profRow">${t.A} ‚Üí ${t.B} ‚Ä¢ ${t.dist} –∫–º ‚Ä¢ ${t.pay} ‚ÇΩ</div>`;
  });
  // reviews
  const rev = JSON.parse(localStorage.getItem('reviews') || '[]');
  const rbox = document.getElementById('profReviews'); rbox.innerHTML = '';
  if(rev.length === 0) rbox.innerHTML = '<div class="small">–û—Ç–∑—ã–≤—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
  else rev.slice(-20).reverse().forEach(r=>{
    rbox.innerHTML += `<div style="padding:8px 0;border-bottom:1px solid rgba(0,0,0,.06)"><b>‚≠ê ${r.stars}</b> <div class="small">${r.text}</div></div>`;
  });
  document.getElementById('profileModal').classList.remove('hidden');
};
document.getElementById('closeProfile').onclick = function(){ document.getElementById('profileModal').classList.add('hidden'); };

/* EXIT button */
document.getElementById('exitVisible').onclick = function(){ location.href = '../business.html'; };

/* Menu items (keep if needed) */
document.getElementById('endShiftVisible').title = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏';
document.getElementById('exitVisible').title = '–í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ç–∞–∫—Å–∏';

/* START flow */
function startOrders(){
  // ensure selectedCar exists (if user didn't select, open car modal)
  if(!selectedCar){
    openCarModal();
    return;
  }
  // initial fill
  generateNewTask();

  refreshOrders();
  // periodic generator
  setInterval(()=> {
    if(orderList.length < 4) {
      orderList.push(makeOrder());
      playSound();
      drawOrders();
    }
  }, 12000);
}

/* initial setup: show car modal */
openCarModal();

/* ensure UI counters updated */
updateRatingUI();
updateTaskUI();
updateQueueUI();
updateXPUI();


</script>
</body>
</html>
